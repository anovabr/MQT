---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Qui quadrado


```{r, include = FALSE }
load(file="~/anovabr/mqt/bases/Base R TDAH Arruda.RData")
library(tidyverse)
library(janitor)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles

library(descr) #chi squared
library(epitools) #epidemiology
```




```{block, type="objectives"}
**Objetivos do capítulo**  
1. Introduzir o Qui quadrado  
2. Realizar gráficos relacionados    
2. Apresentar os pressupostos do teste  
3. Apresentar e interpretar métricas de tamanho do efeito  
5. Dar exemplos relacionados à escrita dos resultados  
```


O Teste Qui-quadrado é um conjunto de, ao menos, três testes estatísticos desenvolvidos para análise de variáveis categóricas e que permitem (1) testar a homogeneidade da distribuição de uma variável (Homogeneity), (2) sua aderência a uma distribuição teórica (Goodness of fit) ou (3) a indepedência entre duas variáveis. Como todos os testes não-paramétricos, ele é livre de uma distribuição de probabilidade característica e a mecânica matemática é similar entre esses três tipos de qui-quadrado:


$$\chi^2=\sum_{k=1}^{n} \frac{(O_k - E_k)^2}{E_k}$$


Os seguintes pressupostos estão presentes na etapa de diagnóstico do modelo:

(i) Os dados são aleatórios e representativos da população de interesse
(ii) A variável de interesse é categórica (ou tratada como categórica)
(iii) O valor esperado para, ao menos 80% de todas as combinações possível (células na tabela) é 5 ou superior.

uma curiosidade que remonta a história e explica parte da desavença que Pearson tinha com Fisher. O qui-quadrado foi originalmente desenvolvido em 1900 e 1904 por Karl Pearson [@Pearson1900]. Ronald Fisher detectou um erro no cálculo dos graus de liberdade e rapidamente divulgou isso, para descontentamento de Pearson [@Baird, 1983].

## Pesquisa
  
<div class="alert alert-info" role="alert">
  <strong>Base: </strong> Base R TDAH Arruda.Rdata
</div>  


Neste capítulo, vamos utilizar a pesquisa intitulada "Parent-reported diagnosis of Attention Deficit Hyperactivity Disorder and psychostimulant use among children and adolescents: a population-based nationwide study", que está em avaliação pela revista "Social Psychiatry and Psychiatric Epidemiology (SPPE)". Neste trabalho, tivemos o objetivo de verificar aspectos epidemiológicos do Transtorno do Déficit de Atenção com Hiperatividade (TDAH) em uma amostra representativa de crianças e adolescentes brasileiros, bem como explorar eventuais associações entre características sociodemográficas, especialmente os sexo do participante, e possíveis fatores e risco e TDAH.

## Execução no R

Neste momento, vamos seguir apenas com o qui-quadrado de independência. Como exposto no decorrer de outros capítulos, o teste de hipóteses começa pela formulação conceitual das hipóteses. Apesar de ser possível estipular $H_0$ e $H_a$ a partir de equações específicas,a apresentação será textual/substantiva.


$$H_0 = Não\ há\ associação\ entre\ sexo\ e\ TDAH \\ H_a = Há\ associação\ entre\ sexo\ e\ TDAH \\ \alpha = 0.05$$
Uma característica colateral a esta apresentação textual do teste de hipóteses do Qui-quadrado é evitar confusões que ocorrem em relação ao conceito do teste e sua formulação matemática. Com muita frequência, dividimos os testes de hipóteses naqueles que verificam "associação" e naqueles que verificam "diferenças". Conceitualmente, o Qui-quadrado investiga associação entre variáveis. No entanto, sua formulação matemática é feita pela diferença entre um valor observado e um valor esperado (tal como ilustrado na equação ao início do capítulo). ASsim, acredito que a formulação apenas textual evita criar confusões e ainda tornar o conteúdo mais palatável.

Posto isso, o gráfico de barras é sempre um bom início para visualizar os dados. Repare que a barra azul (que representa a porcentagem de TDAH) parece se comportar de maneira diferente nos grupos. 

```{r}
ggplot(ds_selected, aes(x= sex_male, fill = adhd_parent)) +
  geom_bar(position = "fill") +
  coord_flip() +
  theme_bw() +
  labs(x = "sexo", y = "Proporção", fill = "TDAH")
```


Em seguida, a tabela de contingência traz informações sobre o relacionamento das variáveis. Apesar do qui-quadrado não eleger uma Vi e uma VD, Com bastante frequência utilizamos as linhas para apresentar a variável de maior interesse (neste caso, sexo) e as colunas para indicar o critério ou o eventual desfecho (neste caso, ter ou não TDAH). A porcentagem nas linhas e o valor esperado (em caso de independência entre as variáveis) auxiliam bastante na descrição dos resultados.


```{r}
CrossTable(ds_selected$sex_male,ds_selected$adhd_parent,
           expected = T,
           chisq = T, prop.c = F, prop.t = F, prop.chisq = F) %>% pander::pander(., digits = 1)
```

O cálculo do qui-quadrado apresentado abaixo deixa claro que que é possível rejeitar a Hipótese nula, uma vez que o valor de P é menor do que o nível de significância previamente estipulado (0.05)

```{r}
CrossTable(ds_selected$sex_male,ds_selected$adhd_parent,
           expected = T,
           chisq = T, prop.c = F, prop.t = F, prop.chisq = F)$CST
```



```{block, type="writing"}
**Como escrever os resultados**  

A associação entre o sexo do participante e sua condição clínica (ter ou não TDAH) foi investida por um Teste Qui-quadrado de independência. Os resultados indicarma que ambas as variáveis são associadas (X2(1) = 41.605).
```  


## Tamanho do efeito  

Como tenho apresentado no decorrer dos outros capítulos, os valores de P quase nunca são informativos sobre a relevância dos resultados. O tamanho do efeito mais utilizado no ambiente das análises de Qui quadardo é o V de Cramer. Esta estatística gera valores 0-1 e é dada da seguinte maneira:

$$V=\sqrt\frac{\chi^2}{n*df^`}$$
Em que:
$\chi^2$ = valor do Qui quadrado obtido
n = tamanho da amostra
$df^`$ menor valor entre (Linhas - 1) ou (Colunas - 1) da tabela de contingências


que pode tem interpretação baseada nos graus de liberdade e é feita da seguinte maneira:

  | Graus de liberdade  | Pequeno           | Médio   |  Grande   
  | :-----------        | :-----------       | :-----------              |  :-----------      
  | 1 (2x2)             | One-sample  t test | Two-samples t test        |  Paired t test
  | 2 (2x3) ou (3x2)    | Signed rank test   | Mann-whitney              |  Wilcoxon




  | Cohen's d | Interpretação         
  | :-----    | :-----     
  | V $\geq$ 0.8   | Grande 
  | V $\geq$ 0.5   | Moderado      
  | V $\geq$ 0.2   | Pequeno
  | V < 0.2   | Irrelevante



```{r}
rcompanion::cramerV(ds_selected$sex_male,ds_selected$adhd_parent)
```


Risco

```{r}
#relative risk (boys)
riskratio(ds_selected$sex_male,ds_selected$adhd_parent) 
oddsratio(ds_selected$sex_male,ds_selected$adhd_parent, method =  "wald")
```

