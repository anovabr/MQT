---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Estatística Descritiva

```{r base pesquisa_espanha e pacotes, include = FALSE }

load("~/anovabr/mqt/bases/Base R - Pesquisa mapfre.RData") #base

library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles

library(DiagrammeR) #flowcharts
library(gridExtra) #plot together
library(janitor) #descritipve stats

```


```{block, type="objectives"}
**Objetivos do capítulo**  
1. Apresentar tabelas e gráficos  
2. Introduzir os verbos do dplyr e funções do ggplot.  
3. Oferecer heurísticas ou regras gerais para criação de gráficos
```

## Pesquisa
  
<div class="alert alert-info" role="alert">
  <strong>Base:</strong> Base R - Pesquisa mapfre.RData
</div>  

Neste capítulo (e em alguns outros), vamos utilizar a pesquisa intitulada ["Depression and Anxiety Symptoms in a Representative Sample of Undergraduate Students in Spain, Portugal, and Brazil"](https://doi.org/10.1590/0102.3772e36412 ). Nessa pesquisa, sou o coautor e o pesquisador responsável para correspondência.


O objetivo deste estudo foi fazer um mapa epidemiológico de sintomas de ansiedade e depressão em universitários em três países, bem como investigar possíveis relações entre tais condições de saúde e fatores sociodemográficos. Um diferencial importante do trabalho foi a seleção amostral. Partiu-se de uma amostra estratificada (probabilística) dos estudantes de três universidades, PUC-Rio (Brasil), Universidade de Extremadura (Espanha) e Universidade de Coimbra (Portugal). Isso permitiu ter maior validade externa dos resultados.


## Condições gerais  

Todo documento acadêmico e científico é composto de <u>aspectos textuais</u>, <u>tabulares</u> e <u>gráficos</u> que devem caminhar na mesma direção e serem <u>sempre associados às perguntas e objetivos traçados na pesquisa</u>. É fácil perceber, dessa maneira, que a parte principal de qualquer trabalho acadêmico não são necessariamente os aspectos estatísticos, mas sim os objetivos e as possíveis hipóteses investigadas pelos pesquisadores. A estatística, neste sentido, é uma valiosa ferramenta de trabalho (ou uma atividade de meio) para que as perguntas sejam respondidas de forma adequada e válida.

Frequentemente, as primeiras análises descritivas começam pela apresentação de <u>tabelas</u> e <u>gráficos</u>. Da mesma forma que a construção de um prédio depende que andaimes sejam colocados, um relatório técnico depende dessas condições. Ainda neste sentido, assim como a conclusão do prédio cursa com a retirada destes andaimes, é bem possível que as versões finais de artigos científicos ou relatórios aproveitem apenas parte dos gráficos e tabelas desenvolvidos. 


## Tabelas

Tabelas apresentam os sumários informacionais de uma pesquisa de maneira reunida e objetiva. As tabelas precisam ter um título informativo, bem como colunas e linhas. Com frequência, apenas as linhas superiores e inferiores recebem bordas e números decimais são arredondados até a segunda casa decimal.  

Como os verbos do dplyr possibilitam que os mesmos resultados sejam encontrados por vias diferentes, os códigos a seguir tentarão manter uma uniformidade lógica. Em alguns momentos, para ampliar as possibilidades de codificação, sintaxes extras serão oferecidas.  

A tabela a seguir apresenta a quantidade de participantes em cada país.

```{r}
Dataset <- Dataset %>% ungroup()
Dataset %>% 
  group_by(country) %>% 
  summarise(n=n()) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

É também possível adicionar proporções relativas percentuais à tabela, o que é uma escolha adequada para apresentação dos resultados.


```{r}
Dataset %>% 
  group_by(country) %>% 
  summarise(n=n(), Prop = n/nrow(.)) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


O pacote `janitor` oferece complementos úteis à família tidyverse e um deles justamente adiciona os totais, de maneira mais rápida e, em função disso, os exemplos também irão acessar as funções deste pacote.

```{r}
Dataset %>% 
  tabyl(country) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


O mesmo que foi realizado com os países, pode também ser realizado com o sexo do participante.

```{r}
Dataset %>% 
  tabyl(sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

É possível notar casos ausentes na variável sexo. Isso acontece com muita frequência e antes de formalmente discutirmos o que fazer neste caso, é possível adequar a tabela para não apresentar tais condições.A adição do argumento para filtrar os participantes com dados ausentes sobre sexo auxilia a apresentar melhor os resultados. É importante atentar que essa análise tem finalidade descritiva e que omitir a apresentação de variáveis ausentes <u>não significa excluir ou remover os participantes</u> das análises que serão feitas posteriormente. Somente em possibilidades remotas se retira participantes das análises de maneira definitiva.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  tabyl(sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

Para fazer uma tabela cruzada, em que seja possível apresentar a quantidade de homens e mulheres por país, épossível utilizar função `pivot_wider`:

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  count(country,sex) %>% 
  pivot_wider(names_from = sex, values_from = n) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Da mesma maneira como continuar com o `tabyl`, mas agora adicionando uma variável.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  tabyl(country, sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Finalmente, para apresentar a quantidade de participantes totais, bem como separar a quantidade e a porcentagem de homens e mulheres por país, a codificação torna-se mais densa. O código abaixo apresenta os comentários para auxiliar no entendimento da rotina e reproduz parcialmente a tabela 1 do artigo.

```{r}
Dataset %>%
  filter(!is.na(sex)) %>% 
  tabyl(country, sex) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>% 
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_ns() %>%
  adorn_title("combined") %>%
  kable(., digits = 2,  booktabs = T) %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")
```


## Gráficos

A máquina gráfica do tidyverse é o ggplot. <u>Pelo menos</u> 3 argumentos são necessários para criação de gráficos, que são:

1. O banco dados `(data = )`, que pode ser omitido da sintaxe,    
2. O aspecto estético, que permite diferentes complementos `aes(x = , y = , fill = , color = )`,  
3. O aspecto geométrico, que varia em função do gráfico a ser apresentado `geom_ ` 

É também possível adicionar outros argumentos, como:  
4. Transformações estatísticas `stat_summary`  
5. Facetas para dividir a visualização `facet_`  
6. Sistema de coordenadas `coord_`  
7. Temas específicos `theme_ `  

É importante notar que apesar dos argumentos utilizados na sintaxe serem similares aos utilizados em toda família tidyverse, a ligação `%>%` é substituída pelo `+`. 

Quando bem feitos, os gráficos são extremamente úteis. Como aponta Morettin e Bussab [@morettin_bussab_2010], eles possibilitam:   
(a) buscar padrões e relações;     
(b) confirmar (ou não) certas expectativas que se tinha sobre os dados;   
(c) descobrir novos fenômenos;  
(d) confirmar (ou não) suposições feitas sobre os procedimentos estatísticos usados; e  
(e) apresentar resultados de modo mais rápido e fácil.  

É sempre bom que o gráfico tenha um título e uma escala. A maioria dos gráficos são apresentados em um plano com um eixo horizontal (abcissas) e um vertical (ordenadas), que se referem  aos níveis da variável que está sendo medida (eixo x) e as contagens ou proporções encontradas (eixo y) ou aos níveis da variável independente (eixo x) e os resultados médios da variável dependente (eixo y).

Para eleger que gráfico será realizado, é necessário responder a duas perguntas que são atreladas às pesquisas em Psicologia e áreas congêneres:  

1. Quantas variáveis serão apresentadas ?  
2. Qual o nível de medida da variával independente ?  

O diagrama abaixo oferece uma árvore de decisão funcional.

```{r, echo=FALSE}

grViz("digraph flowchart {
      # node definitions with substituted label text
      
      node [
      fontname = Helvetica,
      fillcolor = 'Orange', 
      shape = rectangle,
      style = filled]
      
      A[label = 'Quantas variáveis vão ser apresentadas?']
      B[label = 'Nivel de medida da VI']
      C[label = 'Nivel de medida da VI']
      

      node [fillcolor = 'white', style = filled]
      A -> 'Apenas 1';
      A -> '2 ou +';

      'Apenas 1' -> B -> { 'Discreta' 'Contínua' };
      '2 ou +' -> C -> { 'Discreta ' 'Contínua '};
       
       Discreta -> { Setor Barras }
       Contínua -> { Histograma Densidade Boxplot }
       
       
       'Discreta ' -> { 'Barras ' Colunas 'Boxplot ' }
       'Contínua ' -> { Linhas Dispersão }
       
       
     }")


```

É importante atentar que variáveis categóricas são operacionalmente entendidas como discretas aqui.


## 1 variável discreta

Quando há apenas uma variável discreta (incluindo aqui as categóricas), os gráficos são criados para apresentar as contagens e/ou suas proporções. Nesse caso, é recomendado utilização de um <u>gráfico de barras</u> ou <u>gráfico de setor</u>. Apesar de ser possível apresentar as frequências absolutas, esses resultados podem gerar distorção da informação e, portanto, é preferível sempre apresentar as proporções de ocorrência de uma determinada variável ou valor. Por definição, quando se trabalha com proporções, o valor máximo da soma das proporções é 100.

O gráfico de barras abaixo apresenta a contagem absoluta dos participantes pesquisados em cada país.

```{r}
ggplot(Dataset, aes(x = country)) +
  geom_bar() +
  labs(x = "País", title = "Número de participantes nos países investigados")

```

Já abaixo, as barras são utilizadas considerando os resultados proporcionais. Para isso, um recurso do pacote `scales` foi utilizado para adequar o eixo y e também para adicionar o valor às colunas.

```{r}
ggplot(Dataset, aes(x = country, y = ..prop.., group = 1)) + 
  geom_bar(stat = "count") +
  geom_text(aes(label=scales::percent(round(..prop..,2)), 
                y=..prop..), stat= "count", color = "white", size = 3, position = position_stack(vjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "País", title = "Proporção de participantes em cada país investigado")
```

O gráfico de setor (as vezes chamado de polar, pizza ou torta) pode também ser utilizado. O aspecto principal desse gráfico é apresentar os setores de maneira proporcional às frequências.

```{r}
ggplot(Dataset, aes(x=factor(1), fill=country))+
  geom_bar(width = 1) +
  coord_polar("y") +
  labs(title = "Proporção de participantes em cada país")
```

A adição de porcentagens costuma deixar o gráfico mais informativo

```{r}
Dataset %>% 
  count(country) %>% 
  mutate(pct = n/sum(n)) %>% 
  ggplot(., aes(x="", y= pct, fill=country)) +
  geom_col() +
  geom_text(aes(label = scales::percent(round(pct,3))), position = position_stack(vjust = 0.5))+
  coord_polar(theta = "y") +
  labs(title = "Proporção de participantes em cada país")
```


## 1 variável contínua

Quando uma única variável é apresentada no gráfico e ela é continua, os gráficos adequados são o histograma, densidade (kernel) e o boxplot.

Abaixo um histograma da idade dos participantes:

```{r}
ggplot(Dataset, aes(x = age)) +
  geom_histogram(bins = 30, color = "black", fill = "lightgrey") +
  labs(title = "Distribuição da idade dos participantes")
```

Abaixo um gráfico de densidade da idade:

```{r}
ggplot(Dataset, aes(x = age)) +
  geom_density(fill = "lightgray") +
  labs(title = "Distribuição da idade dos participantes")
```

Esses dois gráficos apresentam bem o <u>formato</u> da distribuição. Neste caso, existe uma assimetria à direita, que é para onde a cauda dos dados se arrasta.

Por sua vez, abaixo o boxplot dessa mesma variável: 

```{r}
ggplot(Dataset, aes(y = age, x = "")) +
  geom_boxplot() +
  labs(title = "Distribuição da idade dos participantes")
```

O boxplot tem vantagens em comparação com os outros gráficos apresentados até agora. Além de apresentar o formato da distribuição, a área da caixa reúne 50% da distribuição (Q1, Q2 ou Mediana e Q3) e os bigodes são construídos com base em `Q1 - 1.5*IQR` e `Q3 + 1.5*IQR`.

Apesar de algo difícil de visualizar ao início, a informação apresentada no boxplot e no gráfico de densidade são iguais. 

```{r}
gridExtra::grid.arrange(
  #Grafico 1
  ggplot(Dataset, aes(x = age)) +
  geom_density(fill = "lightgray"),
  
  #Grafico 2
  ggplot(Dataset, aes(y = age, x = "")) +
  geom_boxplot() +
  coord_flip(),
  
  top = "Distribuição da idade dos participantes" #título
)

```


## 2 variáveis com VI discreta (e VD contínua)  

Gráficos de barras ou colunas (considerando aqui as barras de erro) e o boxplot são adequados para apresentar essa relação. Basicamente, esses gráficos permitem verificar a <u>diferença</u> entre os grupos. 

Como exemplo, o gráfico abaixo mostra os resultados do Inventário Beck de Ansiedade entre 3 países investigados. As barras de erro são importantes para verificar, inicialmente, as possíveis diferenças significativas entre os países.

```{r}
ggplot(Dataset, aes(x = country, y = bai_sum)) +
  geom_bar(stat = "summary", fun = mean) +
  stat_summary(geom = "errorbar",fun.data = mean_se, width = .5) 
```

O boxplot a seguir também é um gráfico indicado:

```{r}
ggplot(Dataset, aes(x = country, y = bai_sum)) +
  geom_boxplot()
```


## 2 variáveis com VI contínua (e VD contínua)  

Assumindo que a VI é contínua e a VD também, o gráfico de pontos e de dispersão são virtualmente identicos e indicados. Esses gráficos permitem verificar a <u>associação</u> entre as variáveis. No ggoplot, o argumento `geom_point` (à esquerda) e `geom_jitter` (à direita) são possíveis. 

```{r}
gridExtra::grid.arrange(
  #Grafico 1
  ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_point(),
  
  #Grafico 2
  ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_jitter(),
  nrow=1
)


```


Tradicionalmente, de maneira análoga às barras de erros apresentadas em gráficos cujas VIs são discretas, adiciona-se uma reta de regressão amostral (FRA) quando a VI é contínua, tal como apresentado a seguir. É importante atentar que o capítulo sobre modelos de regressão irá trabalhar melhor este conceito.

```{r}
ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_jitter() +
  geom_smooth(method = "lm")
```

## Outros gráficos e configurações

Evidentemente, é possível apresentar mais informações nos gráficos com mais de um variável apresentada, desde que elas sejam relacionadas ao problema de pesquisa estudado e não sobrecarreguem a visualização dos resultados. Frequentemente, as informações adicionais são feitas pela inclusão de <u>clusters</u> ou <u>agrupamentos</u>. Isso é tanto possível em gráficos cuja VI seja discreta quanto contínua.

No exemplo abaixo, o gráfico dos resultados do Inventário Beck de Ansiedade entre os 3 países investigados (VI discreta) agora está agrupado pelo sexo do participante.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = country, y = bai_sum, fill = sex)) +
  geom_bar(stat = "summary", position = "dodge") +
  stat_summary(geom="errorbar", fun.data = mean_se, position = position_dodge(0.95), width = .5) 
```

Já no exemplo abaixo, a relação entre idade e pontuação no Inventário Beck de Ansiedade está agora agrupada pelo sexo do participante.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex)) +
  geom_jitter() +
  geom_smooth(method = "lm") 
```

Em situações onde existe uma grande quantidade de informação para ser apresentada, os resultados começam a se tornar difíceis de serem entendidos. O gráfico abaixo, por exemplo, é excessivamente carregado de informação e, consequentemente, inadequado.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex, shape = country)) +
  geom_jitter() +
  geom_smooth(method = "lm") 
```

Em outro sentido, o gráfico a seguir quebra a apresentação dos resultados por país e, com isso, potencializa que a informação seja melhor compreendida.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  facet_wrap( ~ country)
```


## Resumo  

Este capítulo apresentou os aspectos tabulares e gráficos corriqueiramente encontrados em pesquisas de Psicologia e áreas congêneres. Entre os pontos principais, a heurística típica de construção de gráficos é um conteúdo importante para ser sempre lembrado e tem as seguintes condições:

1. O gráfico deve ser sempre informativo e não oferecer distorções dos resultados
2. A quantidade e a natureza (escala ou nível de medida) das variáveis definem o gráfico a ser feito
3. Quando bem feitos, gráficos permitem um primeiro resultado inferencial
