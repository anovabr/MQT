--- 
title: "Métodos quantitativos em Psicologia com R"
author: "[Luis Anunciação (PUC-Rio), PhD](mailto: luisfca@gmail.com)"
date: "`r Sys.Date()`"
always_allow_html: yes
description: This book was written for undergraduate level students on Quantitative Methods at the Pontifical Catholic University of Rio de Janeiro (PUC-Rio). The primary goal of this book is to provide a short and to-the-point exposition on the essentials of statistics. To a lesser degree, the mathematical modeling of statistical questions will be addressed. I expect this book can also help students who enroll for laboratory-based statistics and anyone who wants to learn R.
documentclass: book
github-repo: cjvanlissa/gitbook-demo
link-citations: yes
colorlinks: yes
bibliography:
- book.bib
- packages.bib
site: bookdown::bookdown_site
biblio-style: apalike
---

```{r}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
```

# Introdução

  
Aprender estatística e análise de dados é uma das tarefas mais importantes e desafiadoras que existe no meio acadêmico, especialmente às disciplinas agrupadas em ciências humanas, como Psicologia. Por consequência, ensinar ambas as matérias também impõe um desafio enorme, mas necessário.

Por diversas razões, as pesquisas feitas em Psicologia apresentam muitas informações misturadas e sobrepostas e a utilização da estatística é fundamental para conseguir separar e filtrar àquelas informações que temos interesse (sinal) daquelas que apenas distorcem estas primeiras (ruído).

## Objetivo 

Este livro tem como objetivo introduzir conceitos teóricos e aspectos computacionais de estatística de maneira pragmática, direta ao ponto e a partir de perguntas previamente exploradas em pesquisas científicas publicadas. Em menor nível, a modelagem matemática será apresentada e descrita.

Uma das coisas mais importantes para se ter em mente neste livro é que apesar de todo conteúdo ter uma estrutura linear, os capítulos foram construídos de maneira a serem completos em si mesmo e responderem questões específicas, particulares e pontuais. Assim, penso que o livro atende tanto aqueles leitores com interesse em ler a obra inteira, como aqueles que buscam apenas informações mais específicas de um tópico particular.

Evidentemente, esse formato adotado pode gerar uma percepção diferente entre aqueles que consultarem apenas um capítulo ou outro e aqueles que lerem o conteúdo por completo. Isso ocorre pois como muitos testes estatísticos são entendidos como casos particulares de outros, alguns fragmentos que podem parecer destoantes durante uma leitura inicial em alguns capítulos, tornam-se mais fáceis e articulados àqueles que lerem o trabalho inteiro e se dispuserem a fazer uma releitura de partes específicas.  

Para ilustrar, o capítulo sobre o Teste T expõe uma pequena parte sobre modelos de regressão, conteúdo que somente é abordado posteriormente. Se em um primeiro momento isso provavelmente pode gerar alguma (pequena) confusão, a releitura do capítulo após o término da sequência do livro tende a gerar, além de um conhecimento mais profundo por parte do leitor, a percepção da integração tanto da estrutura do livro, como da relação existente entre diferentes modelos estatísticos. 

## Bases

Todas as bases de dados utilizadas neste livro são frutos de pesquisas empíricas que apresentam artigos publicados. Uma vez que o objetivo de um livro é diferente do objetivo da publicação de um artigo, alguns ajustes foram feitos às bases para torná-las mais acessíveis. Nenhuma alteração foi realizada nos dados, mas apenas em mudanças em relação a nomes de variáveis e quantidade de vetores.

Todo material pode ser acessado livre e grauitamente em https://github.com/anovabr/mqt/tree/master/bases

## Pacotes e sintaxes

Este livro utiliza majoritariamente o ambiente [tidyverse](https://www.tidyverse.org/) para realização das análises. Entretanto, sempre que necessário, funções R-base e uso de outros pacotes serão utilizados. Toda codificação utilizada no livro é exibida nos capítulos e integralmente disponível gratuitamente neste (GitHub)[https://github.com/anovabr/mqt]   




<!--chapter:end:index.Rmd-->

# Aspectos gerais

[Versão de testes] Conforme já explicitado, a estatística pode ser dividida em duas áreas interligadas: estatística descritiva e estatística inferencial. O objetivo da estatística descritiva é apresentar sínteses e resumos dos resultados a partir de gráficos e tabelas. Não é intenção dessa área fazer generalizações ou extrapolar os resultados obtidos em uma pesquisa a pessoas não investigadas durante a coleta de dados. Por contraste, a estatística inferencial visa extrapolar os dados e fazer generalizações que toquem toda população de onde aquela mostra foi retirada e é representativa. Dessa maneira, o principal objetivo da estatística inferencial é, de fato, fazer inferências. 

Apesar de livros e aulas unirem ambas as áreas da estatística, alguns pontos merecem destaque, que são:  

1. A estatística descritiva surgiu antes que a inferencial. A etimologia da palavra talvez ajude a entender, uma vez que estatística vem da palavra estado e este sempre teve interesse em saber quantos eram os cidadãos de um determinado local para, entre outras atividades, taxá-los. Dessa maneira, aspectos descritivos antecedem os inferenciais. Por sua vez, a estatística inferencial guarda origem e proximidade com a teoria dos jogos e, consequentemente, isso ajuda a entender o motivo pelo qual a maioria dos exemplos inferenciais envolvem jogos de azar.

2. A estatística tem duas "escolas" ou "formas de pensamento". A estatística frequentista e a estatística bayesiana. Aspectos fundamentais que tocam à definição de probabilidade são diferentes, bem como a definição de dados e parâmetros também o são. Pela perspectiva histórica, a estatística bayesiana é mais antiga que a frequentista. No entanto, se for comparado a proporção de uso entre os pesquisadores, a estatística frequentista é ainda a mais frequente e justifica a ênfase deste livro nesta área.

3. A relação entre estatística e Machine Learning (ML) é relativamente recente. Apesar de grande interface, e do fato que as análises realizadas em estatística e ML encontram resultados virtualmente idênticos, as áreas têm objetivos diferentes. Ainda sob perspectiva histórica, a estatística, como uma área do conhecimento, é anterior à ML e, também por isso, justifica a ênfase do livro.

<!--chapter:end:01-aspectos_gerais.Rmd-->

---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Estatística Descritiva

```{r base pesquisa_espanha e pacotes, include = FALSE }

load(file="C:/Users/luisf/OneDrive/Documentos/anovabr/mqt/bases/Livro - Dados - Brasil e espanha fusionados.RData")

library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles
library(DiagrammeR) #flowcharts
library(gridExtra) #plot together
library(janitor) #descritipve stats
```


```{block, type="objectives"}
**Objetivos do capítulo**  
1. Apresentar tabelas e gráficos  
2. Introduzir os verbos do dplyr e funções do ggplot.  
3. Oferecer convenções ou regras gerais para criação de gráficos
```

## Pesquisa
  
<div class="alert alert-info" role="alert">
  <strong>Base:</strong> Dados - Brasil e espanha fusionados
</div>  

Neste capítulo (e em alguns outros), vamos utilizar a pesquisa intitulada "Sintomas de depressão e ansiedade em universitários espanhóis, portugueses e brasileiros", com previsão de publicação pela Revista Psicologia: Teoria e Pesquisa em 2020. Nessa pesquisa, sou o coautor e o pesquisador responsável para correspondência.


O objetivo da pesquisa foi explorar sintomas de ansiedade e depressão em universitários, bem como investigar possíveis relações entre tais traços latentes e fatores sociodemográficos. Um diferencial importante do trabalho foi a seleção amostral. Partiu-se de uma amostra estratificada (probabilística) dos estudantes de três universidades, PUC-Rio (Brasil), Universidade de Extremadura (Espanha) e Universidade de Coimbra (Portugal). Isso permitiu ter maior validade externa dos resultados.


## Condições gerais  

Todo documento acadêmico e científico é composto de <u>aspectos textuais</u>, <u>tabulares</u> e <u>gráficos</u> que devem caminhar na mesma direção e serem <u>sempre associados às perguntas e objetivos traçados na pesquisa</u>. É fácil perceber, dessa maneira, que a parte principal de qualquer trabalho acadêmico não são necessariamente os aspectos estatísticos, mas sim os objetivos e as possíveis hipóteses investigadas pelos pesquisadores. A estatística, neste sentido, é uma valiosa ferramenta de trabalho (ou uma atividade de meio) para que as perguntas sejam respondidas de forma adequada e válida.

Frequentemente, as primeiras análises descritivas começam pela apresentação de <u>tabelas</u> e <u>gráficos</u>. Da mesma forma que a construção de um prédio depende que andaimes sejam colocados, um relatório técnico depende dessas condições. Ainda neste sentido, da mesma maneira que a conclusão do prédio cursa com a retirada dos andaimes, é bem possível que as versões finais de artigos científicos ou relatórios aproveitem apenas parte dos gráficos e tabelas desenvolvidos. 

Dito isso, o R e seus pacotes oferecem excelentes ferramentas para aspectos descritivos. No entanto, algumas apresentações relativamente simples frequentemente trazem uma dificuldade computacional intensa, o que pode gerar alguma desvantagem na utilização do R para tais apresentações quando comparados com programas mais acessíveis, como o Excel. No entanto, apesar dessa condição, a relação entre dificuldade e complexidade favorece o R àquelas tarefas mais complicadas, como realizar análises inferenciais e psicométricas, como apresentado a seguir.

![](./img/excel_r.PNG)


## Verbos do dplyr

O dplyr funciona de maneira muito intuitiva. O padrão original do R considera que as operações são realizadas a partir de uma lógica do tipo `verbo(sujeito, complemento)` enquanto o ambiente tidyverse opta por `sujeito %>% verbo(complemento)`, tornando-se o ato de programar mais natural e associado à maneira que organizamos as ideias. 

Os verbos principais do pacote estão listados na tabela a seguir e as sintaxes deixadas no decorrer deste capítulo (e do livro) permitem uma melhor apreensão das funcionalidades. É importante lembrar que, em alguns momentos, em função da praticidade computacional, algumas sintaxes vão contar com o formato base do R.



| Verbo         | Ação          |
| :------------ | :-----------: |
| glimpse       | Inspeciona os dados |
| count         | Conta os níveis de uma variável |
| select        | seleciona uma variável específica |
| filter        | Filtra os resultados por um nível específico de uma variável |
| group_by      | Agrupa os resultados por níveis de uma variávei específica |
| summarise     | Apresenta sumários (com medidas estatísticas)  |
| mutate        | Cria novas variáveis ou altera as existentes  |
| arrange       | Organiza a apresentação dos resultados  |
| left_join     | Junta bases ou colunas  |
| pivot_longer        | Transforma uma base larga em longa  |
| pivot_wider        | Transforma uma base longa em larga  |



É também importante ficar atento às atualizações do dplyr e do sistema tidyverse como um todo. Eventualmente, mudanças podem ocorrer e impossibilitar (ou dificultar) a reprodução de rotinas antigas. O [site](https://www.tidyverse.org/) é o local ideal para acompanhar as atualizações. 

## Tabelas

Tabelas apresentam os sumários informacionais de uma pesquisa de maneira reunida e objetiva. Como os verbos do dplyr possibilitam que os mesmos resultados sejam encontrados por vias diferentes, os códigos a seguir tentarão manter uma uniformidade lógica. Em alguns momentos, para ampliar as possibilidades de codificação, sintaxes extras serão oferecidas.  

A tabela a seguir apresenta a quantidade de participantes em cada país.

```{r}
Dataset %>% 
  group_by(country) %>% 
  summarise(n=n()) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

É também possível adicionar proporções relativas à tabela, o que é uma escolha adequada para apresentação dos resultados.


```{r}
Dataset %>% 
  group_by(country) %>% 
  summarise(n=n(), Prop = n/nrow(.)) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


O pacote `janitor` oferece complementos úteis à família tidyverse e um deles justamente adiciona os totais, de maneira mais rápida e, em função disso, os exemplos também irão acessar as funções deste pacote.

```{r}
Dataset %>% 
  tabyl(country) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```


O mesmo que foi realizado com os países, pode também ser realizado com o sexo do participante.

```{r}
Dataset %>% 
  tabyl(sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

A adição do argumento para filtrar os participantes com dados ausentes sobre sexo auxilia a apresentar melhor os resultados. É importante atentar que essa análise tem finalidade descritiva e que omitir a apresentação de variáveis ausentes <u>não significa excluir ou remover os participantes</u> das análises que serão feitas posteriormente. Somente em possibilidades remotas se retira participantes das análises de maneira definitiva.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  tabyl(sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

Para fazer uma tabela cruzada, em que seja possível apresentar a quantidade de homens e mulheres por país, épossível utilizar função `pivot_wider`:

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  count(country,sex) %>% 
  pivot_wider(names_from = sex, values_from = n) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Da mesma maneira como continuar com o `tabyl`, mas agora adicionando uma variável.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  tabyl(country, sex) %>% 
  adorn_totals() %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Finalmente, para apresentar a quantidade de participantes totais, bem como separar a quantidade e a porcentagem de homens e mulheres por país, a codificação torna-se mais densa. O código abaixo apresenta os comentários para auxiliar no entendimento da rotina.

```{r}
Dataset %>% #get data
  #filter 
  filter(!is.na(sex)) %>% 
  
  #agrupar
  group_by(country, add=TRUE) %>% 
  mutate(participantes = n()) %>% 

  #adicionar a relacao de quantidade de pais e sexo
  group_by(country, sex, participantes, add=TRUE) %>% 

  summarise(
    #cria a contagem de sexo
    sex_count = n(), 
    #cria a porcentagem de sexo por pais
    sex_percentage = round(sex_count/first(participantes),2)) %>%
  # cria uma variável agrupada
    mutate(n_percentage = paste0(sex_count," (",sex_percentage,")")) %>% 
  #seleciona apenas as variaveis de interesse
  select(country, sex, n_percentage, participantes)  %>%
  #Muda para formato largo de apresentação
    spread(sex, n_percentage, fill="-") %>% 
  #coloca os totais
  janitor::adorn_totals("row") %>% 
  kable(., digits = 2,  booktabs = T) %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")

```

Ainda a partir da função `tabyl`, a realização desta tabela é simplificada.

```{r}
Dataset %>%
  filter(!is.na(sex)) %>% 
  tabyl(country, sex) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>% 
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_ns() %>%
  adorn_title("combined") %>%
  kable(., digits = 2,  booktabs = T) %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")
```


## Gráficos

A máquina gráfica do tidyverse é o ggplot. <u>Pelo menos</u> 3 argumentos são necessários para criação de gráficos, que são:

1. O banco dados `(data = )`, que pode ser omitido da sintaxe,    
2. O aspecto estético, que permite diferentes complementos `aes(x = , y = , fill = , color = )`,  
3. O aspecto geométrico, que varia em função do gráfico a ser apresentado `geom_ ` 

É também possível adicionar outros argumentos, como:  
4. Transformações estatísticas `stat_summary`  
5. Facetas para dividir a visualização `facet_`  
6. Sistema de coordenadas `coord_`  
7. Temas específicos `theme_ `  

É importante notar que apesar dos argumentos utilizados na sintaxe serem similares aos utilizados em toda família tidyverse, a ligação `%>%` é substituída pelo `+`. 

Quando bem feitos, os gráficos são extremamente úteis. Como aponta Morettin e Bussab [@morettin_bussab_2010], eles possibilitam:   
(a) buscar padrões e relações;     
(b) confirmar (ou não) certas expectativas que se tinha sobre os dados;   
(c) descobrir novos fenômenos;  
(d) confirmar (ou não) suposições feitas sobre os procedimentos estatísticos usados; e  
(e) apresentar resultados de modo mais rápido e fácil.  

É sempre bom que o gráfico tenha um título e uma escala. A maioria dos gráficos são apresentados em um plano com um eixo horizontal (abcissas) e um vertical (ordenadas). Por sua vez, tais planos se referem, nessa ordem, ou aos níveis da variável que está sendo medida (eixo x) e as contagens ou proporções encontradas (eixo y) ou aos níveis da variável independente (eixo x) e os resultados médios da variável dependente (eixo y).

Para eleger que gráfico será realizado, é necessário responder a duas perguntas que são atreladas às pesquisas em Psicologia e áreas congêneres:  
1. Quantas variáveis serão apresentadas ?  
2. Qual o nível de medida da variával independente ?  

O diagrama abaixo oferece uma árvore de decisão funcional.

```{r, echo=FALSE}

grViz("digraph flowchart {
      # node definitions with substituted label text
      
      node [
      fontname = Helvetica,
      fillcolor = 'Orange', 
      shape = rectangle,
      style = filled]
      
      A[label = 'Quantas variáveis vão ser apresentadas?']
      B[label = 'Nivel de medida da VI']
      C[label = 'Nivel de medida da VI']
      

      node [fillcolor = 'white', style = filled]
      A -> 'Apenas 1';
      A -> '2 ou +';

      'Apenas 1' -> B -> { 'Discreta' 'Contínua' };
      '2 ou +' -> C -> { 'Discreta ' 'Contínua '};
       
       Discreta -> { Setor Barras }
       Contínua -> { Histograma Densidade Boxplot }
       
       
       'Discreta ' -> { 'Barras ' Colunas 'Boxplot ' }
       'Contínua ' -> { Linhas Dispersão }
       
       
     }")


```


## 1 variável discreta

Quando há apenas uma variável discreta (incluindo aqui as categóricas), os gráficos são criados para apresentar as contagens e/ou suas proporções. Nesse caso, é recomendado utilização de um <u>gráfico de barras</u> ou <u>gráfico de setor</u>. Apesar de ser possível apresentar as frequências absolutas, esses resultados podem gerar distorção da informação e, portanto, é preferível sempre apresentar as proporções de ocorrência de uma determinada variável ou valor. Por definição, quando se trabalha com proporções, o valor máximo da soma das proporções é 100.

O gráfico de barras abaixo apresenta a contagem absoluta dos participantes pesquisados em cada país.

```{r}
ggplot(Dataset, aes(x = country)) +
  geom_bar(stats = identity) +
  labs(x = "País", title = "Número de participantes nos países investigados")

```

Já abaixo, as barras são utilizadas considerando os resultados proporcionais. Para isso, um recurso do pacote `scales` foi utilizado para adequar o eixo y e também para adicionar o valor às colunas.

```{r}
ggplot(Dataset, aes(x = country, y = ..prop.., group = 1)) + 
  geom_bar(stat = "count") +
  geom_text(aes(label=scales::percent(round(..prop..,2)), 
                y=..prop..), stat= "count", color = "white", size = 3, position = position_stack(vjust = 0.5)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "País", title = "Proporção de participantes em cada país investigado")
```

O gráfico de setor (as vezes chamado de pizza ou torta) pode também ser utilizado. O aspecto principal desse gráfico é apresentar os setores de maneira proporcional às frequências.

```{r}
ggplot(Dataset, aes(x=factor(1), fill=country))+
  geom_bar(width = 1) +
  coord_polar("y") +
  labs(title = "Proporção de participantes em cada país")
```


## 1 variável contínua

Quando uma única variável é apresentada no gráfico e ela é continua, os gráficos adequados são o histograma, densidade e o boxplot.

Abaixo um histograma da idade dos participantes:

```{r}
ggplot(Dataset, aes(x = age)) +
  geom_histogram(bins = 30, color = "black", fill = "lightgrey") +
  labs(title = "Distribuição da idade dos participantes")
```

Abaixo um gráfico de densidade da idade:

```{r}
ggplot(Dataset, aes(x = age)) +
  geom_density(fill = "lightgray") +
  labs(title = "Distribuição da idade dos participantes")
```

Por sua vez, abaixo o boxplot dessa mesma variável: 

```{r}
ggplot(Dataset, aes(y = age, x = "")) +
  geom_boxplot() +
  labs(title = "Distribuição da idade dos participantes")
```

O boxplot tem vantagens em comparação com os outros gráficos apresentados até agora. A caixa reúne 50% da distribuição (Q1, Mediana e Q3) e os bigodes são construídos com base em `Q1 - 1.5*IQR` e `Q3 + 1.5*IQR`.

Apesar de algo difícil de visualizar ao início, a informação apresentada no boxplot e no gráfico de densidade são iguais. 

```{r}
gridExtra::grid.arrange(
  #Grafico 1
  ggplot(Dataset, aes(x = age)) +
  geom_density(fill = "lightgray"),
  
  #Grafico 2
  ggplot(Dataset, aes(y = age, x = "")) +
  geom_boxplot() +
  coord_flip(),
  
  top = "Distribuição da idade dos participantes" #título
)

```


## 2 variáveis com VI discreta (e VD contínua)  

Gráficos de barras ou colunas (considerando aqui as barras de erro) e o boxplot são adequados para apresentar essa relação. Basicamente, esses gráficos permitem verificar a <u>diferença</u> entre os grupos. 

Como exemplo, o gráfico abaixo mostra os resultados do Inventário Beck de Ansiedade entre 3 países investigados. As barras de erro são importantes para verificar, inicialmente, as possíveis diferenças significativas entre os países.

```{r}
ggplot(Dataset, aes(x = country, y = bai_sum)) +
  geom_bar(stat = "summary") +
  stat_summary(geom = "errorbar",fun.data = mean_se, width = .5) 
```

O boxplot a seguir também é um gráfico indicado:

```{r}
ggplot(Dataset, aes(x = country, y = bai_sum)) +
  geom_boxplot()
```


## 2 variáveis com VI contínua (e VD contínua)  

Assumindo que a VI é contínua e a VD também, o gráfico de pontos e de dispersão são virtualmente identicos e indicados. Esses gráficos permitem verificar a **associação** entre as variáveis. No ggoplot, o argumento `geom_point` e `geom_jitter` são possíveis. Abaixo, utilizando os pontos.

```{r}
ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_point()
```

Abaixo, utilizando o jitter

```{r}
ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_jitter()
```

Tradicionalmente, de maneira análoga às barras de erros apresentadas em gráficos cujas VIs são discretas, adiciona-se uma reta de regressão amostral (fra) quando a VI é contínua, tal como apresentado a seguir.

```{r}
ggplot(Dataset, aes(x = age, y = bai_sum)) +
  geom_jitter() +
  geom_smooth(method = "lm")
```

## Outros gráficos e configurações

Evidentemente, é possível apresentar mais informações nos gráficos com mais de um variável apresentada, desde que elas sejam relacionadas ao problema de pesquisa estudado e não sobrecarreguem a visualização dos resultados. Frequentemente, as informações adicionais são feitas pela inclusão de **clusters** ou **agrupamentos**. Isso é tanto possível em gráficos cuja VI seja discreta quanto contínua.

No exemplo abaixo, o gráfico dos resultados do Inventário Beck de Ansiedade entre os 3 países investigados (VI discreta) agora está agrupado pelo sexo do participante.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = country, y = bai_sum, fill = sex)) +
  geom_bar(stat = "summary", position = "dodge") +
  stat_summary(geom="errorbar", fun.data = mean_se, position = position_dodge(0.95), width = .5) 
```

Já no exemplo abaixo, a relação entre idade e pontuação no Inventário Beck de Ansiedade está agora agrupada pelo sexo do participante.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex)) +
  geom_jitter() +
  geom_smooth(method = "lm") 
```

Em situações onde existe uma grande quantidade de informação para ser apresentada, os resultados começam a se tornar difíceis de serem entendidos. O gráfico abaixo, por exemplo, é excessivamente carregado de informação e, consequentemente, inadequado.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex, shape = country)) +
  geom_jitter() +
  geom_smooth(method = "lm") 
```

Em outro sentido, o gráfico a seguir quebra a apresentação dos resultados por país e, com isso, potencializa que a informação seja melhor compreendida.

```{r}
Dataset %>% 
  filter(!is.na(sex)) %>% 
  ggplot(., aes(x = age, y = bai_sum, color = sex)) +
  geom_jitter() +
  geom_smooth(method = "lm") +
  facet_wrap( ~ country)
```


## Resumo  

Este capítulo apresentou os aspectos tabulares e gráficos corriqueiramente encontrados em pesquisas de Psicologia e áreas congêneres. Entre os pontos principais, a heurística típica de construção de gráficos é um conteúdo importante para ser sempre lembrado.

<!--chapter:end:02-estatistica_descritiva.Rmd-->

# Qui quadrado

```{r base e pacotes qui quadrado, include = FALSE }

load(file="C:/Users/luisf/OneDrive/Documentos/anovabr/MQT/bases/Livro - R - ASQ SE all age intervals.RData")

library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles


```

```{block, type="objectives"}
**Objetivos do capítulo**  
1. Apresentar o teste T  
2. Discutir os pressupostos de execução do teste T  
3. Realizar gráficos relacionados à comparação de médias  
4. Apresentar e interpretar métricas de tamanho do efeito  
5. Dar exemplos relacionados à escrita dos resultados 
6. Apresentar versões não paramétricas do teste T (Wilcoxon-Mann-Whitney)
```



<!--chapter:end:04-qui_quadrado.Rmd-->

# Teste T

```{r base e pacotes teste t, include = FALSE }

load(file="C:/Users/luisf/OneDrive/Documentos/anovabr/MQT/bases/Livro - R - ASQ SE all age intervals.RData")

library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles


```

```{block, type="objectives"}
**Objetivos do capítulo**  
1. Apresentar o teste T  
2. Discutir os pressupostos de execução do teste T  
3. Realizar gráficos relacionados à comparação de médias  
4. Apresentar e interpretar métricas de tamanho do efeito  
5. Dar exemplos relacionados à escrita dos resultados 
6. Apresentar versões não paramétricas do teste T (Wilcoxon-Mann-Whitney)
```

O Teste T é um teste estatístico frequentemente utilizado para testar hipóteses sobre <u>diferenças entre médias</u>. Por utilizar dados amostrais para estimar um parâmetro ($\mu$), ele é um teste parâmetrico. Apenas por um preâmbulo histórico, a origem do Teste T remonta o artigo publicado em 1908 por William Gosset. Na época, em função de seu trabalho na cervejaria Guiness, ele não assinou o artigo, mas apenas usou seu pseudônimo *Student*, motivo pelo qual o teste T também é chamado de Teste T de Student.   

É importante notar que estudantes de Psicologia e profissionais que trabalham com avaliação psicológica costumam ser deparados com uma métrica chamada "T score" (Escore T, as vezes), desenvolvido em 1939 por um professor de Psicologia (William Anderson McCall). Tenha em mente que essa métrica não ter relação com os procedimentos inferenciais relacionados ao teste T a não ser uma similaridade de nome [@McCall1939; @Krus1977]. 

É possível estipular que o Teste T pode ser utilizado para comparar a média de uma amostra com a média populacional (*one sample t test*), para comparar duas médias amostrais (*two sample t test*), ou para  comparar duas médias de uma mesma amostra que foi investigada em dois momentos do tempo (*paired ou matched t test*). 

Se assume os seguintes pressupostos funcionais à execução de um Teste T:  

*(i)* Os dados são aleatórios e representativos da população
*(ii)* a variável dependente é contínua
*(iii)* A distribuição dos resultados populacionais é assumida como normal  

Quando há o interesse de utilizar o Teste T para comparar os resultados de dois grupos, é também necessário que: 

*(iv)* As variâncias dos grupos seja homogênea (princípio da homocedasticidade)
*(v)* ambos os grupos sejam independentes

Quando se utiliza o Teste T pareado, se viola o princípio da independência, mas é necessário que:  

*(vi)* o tamanho amostral seja o mesmo


Eventualmente, quando os pressupostos são violados, versões não-paramétricas podem ser implementadas. A tabela abaixo concatena os testes estatísticos relacionados e, para fins de comparação com outros trabalhos, há autores que sugerem que se use sempre as versões não-paramétricas em resultados obtidos por processos de avaliação psicológica, arguindo que os dados têm nível de medida "ordinal".


  | Versão do teste | Um grupo           | Dois grupos independentes |  Grupos pareados    
  | :-----------    | :-----------       | :-----------              |  :-----------      
  | Paramétrica     | One-sample  t test | Two-samples t test        |  Paired t test
  | Não-paramétrica | Signed rank test   | Mann-whitney              |  Wilcoxon



## Pesquisa
  
<div class="alert alert-info" role="alert">
  <strong>Base: </strong> Livro - R - ASQ SE all age intervals
</div>  


Neste capítulo,  vamos utilizar a pesquisa intitulada “Confirmatory analysis and normative tables for the Brazilian Ages and Stages Questionnaires: Social–Emotional”, publicada em 2019 na Child Care Health Development. Esse trabalho teve dois objetivos. O primeiro visou confirmar a estrutura fatorial de um instrumento utilizado para avaliar competências sociais e emocionais relacionadas ao desenvolvimento infantil (ASQ:SE) e o segundo visou desenvolver tabelas normativas para comparar meninos e meninas. Essa é uma pesquisa muito importante, visto que conta com uma base de dados robusta (mais de 50 mil participantes) e costura psicometria, avaliação psicológica e políticas públicas

## Execução no R  

Como exemplo, a variável dependente do teste T tem de ser contínua. Na base de dados específica às crianças de 12 meses (`asq_12months`), essa variável será computada pela soma de todos os itens da escala. No dplyr, isso é feito pela integração da função `mutate` com a `select`

```{r}
asq_12months <- asq_12months %>% 
  mutate(total_12 = rowSums(select(., starts_with("q_")), na.rm = TRUE))
```

Uma vez que o interesse é o de comparar os resultados médios obtidos por meninos e meninas aos 12 meses, é necessário a escrita adequada das hipóteses e o nível de significância adotado na análise. Dessa maneira:

$$H_0 = \mu_{meninos} - \mu_{meninas} = 0 \\ H_a = \mu_{meninos} - \mu_{meninas} \neq 0 \\ \alpha = 0.05$$

Em seguida, o processo de testagem da hipótese é feito preliminarmente de maneira gráfica e, em seguida, pela implementação do teste específico. Apesar do gráfico não ser decisivo na tomada de decisão, ele auxilia a visualilzação da distribuição da variável que temos interesse, bem como oferece já um entendimento inicial dos resultados.

Posto que a VI é discreta e a VD é continua (exposta no capítulo \@ref(01-estatistica_descritiva)) tanto o gráfico de colunas/barras como o de densidade são úteis. O gráfico de barras tem uma vantagem de ser possível adicionar barras de erros, que serão melhores descritas futuramente.

```{r}
gridExtra::grid.arrange(
  #plot 1 
  ggplot(asq_12months, aes(x = sex, y = total_12, fill = sex)) +
    geom_bar(stat = "summary") +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = .2),
  #plot 2
    ggplot(asq_12months, aes(x = total_12, fill = sex)) + 
    geom_density(color = NA, alpha=.6)
)
  
```

Feito isso, o próximo passo é a testagem formal da hipótese. Como exposto, o teste T de duas amostras independentes assume que os resultados da variável de interesse se distribua normalmente e que variância entre os grupos seja homocedástica. Tecnicamente, como o teste T é um caso especial de um modelo de regressão, a normalidade da variável de interesse se refere aos resíduos do modelo e, neste caso pode ser testada pela distribuição marginal dos resultados de ambos os grupos.  

A normalidade pode ser avaliada graficamente por QQ-plots e por testes específicos, como o Shapiro-wilk, Anderson-Darling e Jarque Bera.

O QQ plot é um gráfico que reúne a distribuição empírica ordenada dos quantis conta os quantis da distribuição teórica (aqui, normal). Se os dados e a linha diagonal se soprepuserem, isso é uma evidencia de que a distribuição empírica é a mesma da distribuição teórica. Caso haja discrepância, isso aponta para desvio da normalidade.

```{r}
ggplot(asq_12months, aes(sample = total_12)) + 
  stat_qq()  + stat_qq_line() +
  facet_wrap(~sex)
```

Apesar do gráfico já ter sido bastante claro e sugerir fortemente desvio da normalidade em ambos os grupos, o teste formal é necessário. O Shapiro-wilk costuma ser utilizado neste caso, uma vez que ele reúne diferentes características positivas no balanço entre erro do tipo 1 e 2. a Hipótese nula desse teste assume que a variável de interesse tem distribuiÇào (aproximadamente) normal. Assim, rejeitar a hipótese nula sugere que esse princípio foi violado e, com isso, o teste T pode ter resultados distorcidos.

```{r}
asq_12months %>% 
  group_by(sex) %>% 
  summarise(shapiro = shapiro.test(total_12)$p.value)
```

De maneira convergente ao gráfico, o Shapiro-wilk também apontou que o princípio da normalidade foi violado. Entretanto, por finalidades didáticas, as análises continuarão.

A homogeneidade das variâncias pode ser testada visualmente e pelo teste de Bartlett ou Levene. De maneira análoga ao Shapiro-wilk, esses testes assumem como Hipótese nula a homogeneidade das variâncias. Consequemente, a rejeição desse pressuposto pode também trazer resultados distorcidos ao resultado do teste T. 


```{r}
bartlett.test(total_12 ~ sex, data = asq_12months)
```

Diferentemente do pressuposto da normalidade, o pressuposto da homocedasticidade foi preservado.  
Agora, finalmente, o teste T.

```{r}
(t_test_12m <- t.test(total_12 ~ sex, var.equal = T, data = asq_12months))
```

Os resultados trazem a média de ambos os grupos (`r t_test_12m$estimate[1]` e `r t_test_12m$estimate[2]`), a estatística do teste (`r t_test_12m$statistic`, as vezes chamada de T calculado), os graus de liberdade 
(`r t_test_12m$parameter`) e o valor de p `r t_test_12m$p.value`. Repare que como o valor de p é superior ao valor estipulado do nível de significância (0.05), falha-se em rejeitar a Hipótese nula, indicando que, apesar de numericamente distintos, os resultados não são estatisticamente significativos.  


```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados por um Teste T de amostras independentes para investigar as diferenças médias nos resultados do desenvolvimento entre meninos e meninas. Os resultados mostraram que os valores médios de meninos e meninas não não são significativamente diferentes (t(1039) = 0.37, p = 0.71). Dessa maneira, as diferenças encontradas podem ser mais bem explicadas por outras fontes de variações. 
```

Com isto concluído, é também possível verificar se existem diferenças em idades mais avançadas. A sintaxe é customizável e torna-se fácil testar a hipótese da diferença, por exemplo, aos 18 meses. Nesse sentido, o teste de hipóteses deve ser normalmente escrito:


$$H_0 = \mu_{meninos} - \mu_{meninas} = 0 \\ H_a = \mu_{meninos} - \mu_{meninas} \neq 0 \\ \alpha = 0.05$$

O gráfico novamente deve ser realizado


```{r}
gridExtra::grid.arrange(
  ggplot(asq_18months, aes(x = sex, y = score, fill = sex)) +
  geom_bar(stat = "summary") +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = .2),

  ggplot(asq_18months, aes(x = score, fill = sex)) + 
  geom_density(color = NA, alpha=.6))
```

Bem como a verificação do pressuposto de normalidade e homocedasticidade, seguidos pelo teste formal.

```{r}
(t_test_18m <- t.test(score ~ sex, var.equal = T,data = asq_18months))
```

Diferentemente do anterior, agora o resultado foi significativo (p < 0.01) e deve ser reportado:


```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados por um Teste T de amostras independentes para investigar as diferenças médias nos resultados do desenvolvimento entre meninos e meninas com 18 meses idade. Os resultados mostraram que os valores médios de meninos (M = 27.5, SD = 21.8) e meninas (M = 24.9, SD = 20.3) são significativamente diferentes (t(5725) = 4.62, p < 0.01). 
```

É importante ter uma atenção especial à significância estatística. <u>De forma alguma</u>, um resultado que rejeita a hipótese nula (como o de agora) deve ser entendido como "aceitação da hipótese alternativa", tampouco como evidência de causalidade. É fundamental lembrar que o valor de P se refere à probabilidade de encontrar a estatística de teste calculada, ou uma ainda mais exterma, assumindo que a hipótese nula é verdadeira. Apesar de algo contra-intuitivo (e talvez desanimador), é assim que a estatística frequentista funciona.

## Tamanho do efeito  

Resultados significativos não são nenhum pouco informativos em relação ao tamanho do efeito. Essa métrica tem mais contato com as perguntas originalmente realizadas em uma pesquisa e é entendida como uma medida objetiva e padronizada da magnitude de um efeito observado independente da significância estatística. Assim, o tamanho do efeito pode ser considerado um indicador da <u>relevância clínica</u> dos grupos (em cenário biométrico, do tratamento ou condiçào).

Existem duas famílias principais no framework do tamanho do efeito, que são a família "d" e a família "r". Tecnicamente, quando comparamos médias, usamos o d de cohen para calcular a distância entre as médias das distribuições normais sobrepostas.

A interpretação é a seguinte:

  | Cohen's d | Interpretação         
  | :-----    | :-----     
  | d $\geq$ 0.8   | Grande 
  | d $\geq$ 0.5   | Moderado      
  | d $\geq$ 0.2   | Pequeno
  | d < 0.2   | Irrelevante


```{r}
library(effsize)
cohen.d(score ~ sex, data = asq_18months)
```

Agora é possível agregar ambos os resultados e a escrita iria por esse caminho.

```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados por um Teste T de amostras independentes para investigar as diferenças médias nos resultados do desenvolvimento entre meninos e meninas com 2 anos de idade. Os resultados mostraram que os valores médios de meninos (M = 27.5, SD = 21.8) e meninas (M = 24.9, SD = 20.3) são significativamente diferentes (t(5725) = 4.62, p < 0.01), apesar do tamanho do efeito ser negligenciável (d = 0.12). 
```  

## Versão robusta do teste T

Em muitas situações, os pressupostos do teste T são violados e parte da literatura argumenta que o teste T é robusto o suficiente para lidar com isso [@Lumley2002], equanto outra parte sugere que é melhor optar por versões com médias aparadas ou não-paramétricas [@Field2017]. No entanto, o que não costuma ser discutido com tanta frequência é que a modificação do teste estatístico utilizado, necessariamente, modifica a hipótese da pesquisa. Nesse sentido, a decisão de alterar o teste estatístico deve ser feito com justificativa teórica por parte do pesquisador.

O pacote `WRS` apresenta versões robusta do Teste T. Ainda, o próprio R base oferece uma solução para condições em que a homogeneidade dos grupos não é aceita, que é o Welch-test. Esse teste é feito assumindo estipulando `var.equal = F` na sintaxe previamente exposta ou removendo este argumento por completo.

## Mann-whitney

A chamada versão não paramétrica do teste T é o teste de Wilcoxon-Mann-Whitney. Quando os pressupostos do teste T são violados, o Mann-Whitney é um forte candidato para sua substituição. Se de um lado esse teste supera tais pressupostos, por outro ele responde a uma hipótese diferente daquela que o teste T trabalha. Enquanto o teste T compara médias, o Mann-whitney compara os valores ranqueados (postos). Nota-se que ele não é um teste para comparar medianas e que isso só ocorre em condições restritas.

```{r}
(mann_whiyney_18m <- wilcox.test(score ~ sex, data = asq_18months))
```


Os resultados foram convergentes ao previamente encontrado e, em outras palavras, tambem apoiam a rejeição da hipótese nula. O tamanho do efeito também pode ser calculado ao implementar $Z/\sqrt{(n)}$. O output padrão do R não oferece essa informação, mas o pacote `coin` dispõe dessa métrica.

```{r}
coin::statistic(coin::wilcox_test(score ~ sex, data = asq_18months))
```

Assim, implementando a fórmula, o tamanho do efeito seria aproximadamete 0.06.


```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados pelo teste Wilcoxon-Mann-Whitney para investigar as diferenças nos resultados do desenvolvimento entre meninos (Mdn = 25, IQR = 30, M = 27.53, SD = 21.61) e meninas (Mdn = 20, IQR = 25, M = 24.95, SD = 20.34) com 18 meses de idade. Os resultados indicaram que os resultados foram significativos (W = 4368187, p < 0.01), mas com efeito negligenciável (0.12). 
```  

## Teste T e regressão

Conforme alertado, o Teste T é um caso particular deum modelo de regressão que assume que a variável independente é uma dummy. Assim, $b_0$ (intercepto) é o grupo que recebeu o valor 0 e $b_1$ (inclinação) é o grupo que recebeu o valor 1. Caso isso não tenha sido definido inicialmente, basta estipular que a variável é um <u>fator</u> e o R cuidará de todo o resto.

Nesse caso, o R atribuiu os meninos como intercepto o valor médio dos meninos e a inclinação $b_1$ é justamente a diferença entre os valores (*24.95-27.53)*. Nesse caso, -2.58. A estatística F é equivalente a $t^2$ do teste t em sua versão tradicional (assumindo variâncias iguais entre grupos, adicionando `var.equal = T` à função).

```{r}
lm(score ~ sex, data = asq_18months) %>% 
  stargazer::stargazer(., type = "text")
```

## Aspectos matemáticos


[Em desenvolvimento]


## Resumo  

Este capítulo introduziu a lógica por detrás do Teste T, ensinou sua execução, interpretaçào e escrita dos resultados. Frequentemente, os pressupostos que são exigidos à execução desse teste são violados e o teste de Wilcoxon-Mann-Whitney costuma ser implementado em substituição. Nesse sentido, este capítulo também apresentou os aspectos básicos deste teste. Finalmente, métricas relacionados ao tamanho do efeito foram calculadas e discutidas. É importante levar deste capítuloq que o Mann-Whitney e o teste T testam hipóteses diferentes e que significância estatística não é sinônimo de relevância clínica.  


<!--chapter:end:05-teste_t.Rmd-->

---
output: html_document
editor_options: 
  chunk_output_type: console
---
# ANOVA


```{r, include = FALSE }

load(file="C:/Users/luisf/OneDrive/Documentos/anovabr/MQT/bases/Livro - R - TEG.RData")
library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles
```

```{block, type="objectives"}
**Objetivos do capítulo**  
1. Apresentar a ANOVA  
2. Discutir os pressupostos de execução da ANOVA  
3. Realizar gráficos relacionados à comparação de médias  
4. Apresentar e interpretar métricas de tamanho do efeito  
5. Dar exemplos relacionados à escrita dos resultados 
6. Discutir os testes post-hoc  
7. Apresentar versões não paramétricas da teste ANOVA (Kruskal-Wallis)  
```


A ANOVA é um teste estatístico desenvolvimento para verificar diferença entre diversos grupos. Pragmaticamente, é possível entender ANOVA como um super teste T, onde o que está em jogo não é somente o quanto as médias amostrais estão distantes, mas o quão distantes estão relativamente à variabilidade de observações individuais.  

Conceitualmente, similar ao teste T, a ANOVA e todas as suas extensões (e.g., ANCOVA e MANOVA) são casos especiais de um modelo de regressão que lidam com variáveis independente discretas/categórica.

Em Psicologia, alguns autores indicam que a ANOVA é a técnica inferencial mais utilizada [@Chartier2008; @Howell2011]. Se por um aspecto, isso é extremamente vantajoso por estreitar a relação entre Psicologia e Estatística, por outro, isso parece ter contribuído para criação e manutenção de diferentes conceitos equivocados sobre a ANOVA. 

Conceitualmente, a ANOVA é um modelo linear, tal que:

\[y_i = b_0 + b_1X{_1}_i + \epsilon_{i}\]

$y_i$ representa a variável dependente  
$b_0$ é o intercepto (coeficiente linear)   
$b_1$ é a inclinação (coeficiente angular)  
$\epsilon_{i}$ é o erro/resíduo   

Todos os pressupostos dos modelos linares são mantidos e o mnemônico LINE auxilia a resgatar todos eles. Assume-se que o erro é independente e identicamente distribuído ($iid$), distribuído normalmente com média 0 e variância constante $\sigma^2$, ou seja:  \[ \epsilon\stackrel{iid}{\sim} \mathcal{N}(\mu,\,\sigma^{2})\,\] Além de homocedástico: \[ VAR(\epsilon |x_1,x_2,...,x_k)=\sigma^2 \].   
`iid`ainda signica erros descorrelatados \[ COV(\epsilon_1,\epsilon_j)=0 \].  

É importante atentar que assumir média 0 $E(\epsilon|x)=0$, também implica que a correlação do erro com as variáveis é nula. Operacionalmente, o erro representa <u>todos os fatores de pesquisa</u> e problemas de medição que afetam o resultado além das variáveis independentes consideradas na modelagem.


Da mesma forma que feito em outros capítulos, a tabela abaixo concatena os testes estatísticos relacionados quando os pressupostos são violados. Para fins de comparação com outros trabalhos, há autores que sugerem que se use sempre as versões não-paramétricas em resultados obtidos por processos de avaliação psicológica, arguindo que os dados têm nível de medida "ordinal".

  | Versão do teste | Um ou mais fatores |  Momentos repetidos             |  
  | :-----------    | :-----------       | :-----------                    |        
  | Paramétrica     | Anova de k via(s)  |  Anova de medidas repetidas     |   
  | Não-paramétrica | Kruskal-Wallis     |  Teste de Friedman ou Page Test |   

A ANOVA tem diversas características de modelagem que serão descritas na seção a seguir,

## Legenda

Diferentes termos são empregados em uma ANOVA e em modelos próximos. A legenda a seguir visa auxiliar no entendimento de cada um deles e aproximar o leitor a conceitos amplos utilizados em modelos lineares:

```{block, type="writing"}
**Fator**: Variável independente,  via, variável fonte, variável preditora, tratamento  
**Desfecho**: Variável dependente, variável critério    
**Níveis**: Grupos, condições, categorias da variável independente  
**Efeito principal**: Efeito da variável independente, sem considerar outras caracterísitcas do modelo   
**Efeito de interação**: Efeito do termo de interação entre duas ou mais variáveis independentes.Quando significativo, não se interpreta os efeitos principais.   
**Efeito simples**: Efeito de uma variável independente em um nível (específico) de outra variável independente.  
**ANCOVA**: Análise de covariância, onde se controla os resultados por uma variável contínua 
**MANOVA**: Análise multivariada de variância, onde se extende a ANOVA para incluir duas variáveis dependentes  
```


Por heurística, se escreve os delinementos estudados por uma ANOVA com $\eta$. Se, por exemplo, o interesse seja o de verificar o efeito do sexo (masculino ou feminino) e da escolaridade (fundamental, médio e superior), a representação será $\eta =  2 \times 3$. Isso significa que a ANOVA tem dois fatores (sexo e escolaridade) e o primeiro fator tem dois níveis e o segundo tem 3 níveis. 


## Pesquisa
  
<div class="alert alert-info" role="alert">
  <strong>Base: </strong> Livro - R - TEG
</div>  


Neste capítulo, vamos utilizar a pesquisa intitulada "A relação entre o nível de Empreendedorismo (TEG) e os aspectos sociodemográficos dos Taxistas cooperados da cidade de Santo André/São Paulo, Brasil", publicada em 2016 na Revista Eletrônica de Gestão e Serviços, em que sou co-autor. O objetivo dessa pesquisa foi identificar o nível de empreendedorismo em 147 taxistas de Santo André/SP, bem como averiguá-lo em associação aos aspectos sociodemográficos. A base contém 14 variáveis, sendo 6 variáveis da escala utilizada para avaliação do empreendedorismo e 8 variáveis gerais, incluindo aqui os aspectos sociodemográficos, como sexo e escolaridade. Essa base será utilizada para realizar uma ANOVA de 1 via, 2 vias e uma ANOVA fatorial.


## ANOVA de 1 via

A pergunta que temos agora é sobre o possível efeito da `escolaridade` na Tendência Empreendedora Geral (`teg`). Trata-se de uma ANOVA de 1 via, dado que existe apenas uma VI, com mais de 2 níveis.  


### Execução no R

Ao trabalhar no R, é <u>fundamental</u> se certificar que os tipos das variáveis estão corretamente definidos em função da escala de medida utilizada. Erros nessa etapa podem gerar resultados absolutamente incorretos. A escolaridade é uma variável categórica (ordinal, tratada como discreta) e é necessário definir claramente isso ao R antes da análise propriamente dita. 

Isso pode ser feito pela função `case_when` e `levels`. O `case_when` irá substituir os valores originalmente presentes nessa variável e o `levels` deixará claro a ordem de cada categoria, o que é útil para que os gráficos sejam feitos corretamente.

```{r, eval=FALSE}
dados_teg <- dados_teg %>% 
  mutate_at(vars(escolaridade), 
    ~factor(case_when(
      . == 1 ~ "Primário",
      . == 2 ~ "Ginásio",
      . == 3 ~ "Colegial",
      . == 4 ~ "Superior"), 
      levels=c("Primário","Ginásio","Colegial","Superior")))
```


Uma vez que os itens de um instrumento sociodemográfico devem levar em consideração o contexto das pessoas avaliadas e, as categorias de escolaridade foram definidas como as apresentadas. Primário significa escolaridade até o 5º ano, ginásio significa escolaridade até o 9º ano e colegial é equivalente ao ensino médio.

As hipóteses precisam ser descritas:

$$H_0 = \mu_{escolaridade_i} - \mu_{escolaridae_j} = 0 \\ H_a = c.c \\ \alpha = 0.05$$
Aqui, o subscrito $i$ e $j$ foi utilizado de maneira liberal para apresentar a diferença entre todas as combinações lineares possíveis.

Em seguida, a apresentação tabular das médias e desvios-padrão pode ser realizada.

```{r}
dados_teg %>% 
  group_by(escolaridade) %>% 
  summarise_at(vars(teg), lst(n=~n(),mean,sd)) %>% 
  kable(digits = 2) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


Tal como ilustrado no decorrer dos outros capítulos, gráficos são fundamentais para entendimento do relacionamento entre as variáveis. Uma vez que a escolaridade (VI) é tratada como discreta e a TEG (VD) é contínua, um gráfico de barras é adequado. A inclusão das barras de erro permite uma compreensão inferencial inicial.

```{r, message=FALSE}
ggplot(dados_teg, aes(x=escolaridade, y = teg, fill = escolaridade)) +
  geom_bar(stat = "summary") +
  stat_summary(fun.data = mean_se, geom = "errorbar") +
  theme(legend.position = "none")
```


A visualização dos resultados já permite identificar algumas caracteríticas gerais. Primeiro, quão maior a escolaridade, maior o o valor obtido na escala. Segundo, algumas barras de erros estão superpostas e outras não, o que nos leva à conclusão preliminar de que resultados significativos estarão presentes na próxima etapa, que é a modelagem formal dessa hipótese.

A modelagem formal irá contemplar n-1 níveis dos preditores e estipulará no intercepto o nível de referência. Dessa maneira:

\[y_{i} = b_{0} + b_1Esc_{ginasio_i} + b_2Esc_{colegial_i} + b_1Esc_{superior_i} + \epsilon_{i}\]

$b_0$ representa o intercepto, que aqui é o valor médio da Escolaridade primária  
$b_i$ representa os outros preditores  
$\epsilon_{it}$ representa o erro

A função `lm` será utilizada e o objeto `mod_escolaridade` será armazenado. É também possível utilizar a função `aov` e a escolha da `lm` foi apenas por conveniência.

```{r}
mod_escolaridade <- lm(teg ~ escolaridade, dados_teg)
```

Antes de checar os resultados, é necessário verificar se os pressupostos da ANOVA foram atendidos. Esses pedem que os resíduos sejam normalmente distribuídos e homocedásticos. Tal como previamente exposto no teste T, a investigação dessas condições é tanto feita por gráficos e testes formais e ambos são muito úteis. A análise da normalidade dos resíduos será inicialmente feita.

O gráfico abaixo apresenta a distribuição dos resíduos:   

```{r, message=FALSE}
ggplot(fortify(mod_escolaridade), aes(.resid)) +
      geom_histogram(colour="black", fill="grey") +
      geom_density(aes(y= ..count..))
```

O teste formal pode ser feito via shapiro-wilk. Tal como no teste T, a $H_0$ desse teste assume normalidade e, idealmente, não deve ser rejeitada.

```{r}
shapiro.test(residuals(mod_escolaridade))
```

Uma vez que o valor foi menor do que o previamente estipulado ao $\alpha$, é possível concluir que o pressuposto da normalidade foi violado. situações como essa são muito frequentes. Na literatura, são presentes recomendações de ajuste dos dados por alguma função `g(.)` ou tornar mais severo o valor de p na interpretação dos resultados. Por exemplo, em vez de 0.05, usar 0.01.

A homocedasticidade pode ser verificada por um gráfico dos resíduos contra os valores previstos. O ideal é não encontrar padrões no gráfico.

```{r}
ggplot(fortify(mod_escolaridade), aes(x=.fitted, y=.resid)) + 
  geom_point() +
  geom_hline(yintercept = 0)
```

Além do teste de Bartlett ou Levene, em que estipulam $H_0$ como homocedasticidade e, idealmente, não deve ser rejeitada.

```{r}
car::leveneTest(mod_escolaridade)
```


A homocedasticidade foi assumida. Dessa maneira, mesmo com a violação da normalidade, o modelo será utilizado e seu sumário geral será apresentado pela função apa.aov do pacote `apaTables`. Isso é importante para garantir resultados programas tipicamente utilizados, como o SPSS e o STATA. Essa tabela é padronizada e muito similar na maioria dos programas estatísticos. Ela traz as seguintes informações principais:


  | Preditor          | Soma dos Quadrados| Graus de liberdade  |  Quadrado médio | Estat. F      | 
  | :-----------      | :-----------      | :-----------        |  :-----------   | :-----------  |  
  | Fator             | Entre (SSB)       | K-1                 |  MSB = SSB/ k-1 | F = MSB/MSW   | 
  | Resíduo           | Dentro (SSW)      | N-k                 |  MSW = SSW/ N-K |               |
  | Total             | Total (SQT)       | N-1                 |  


Aqui, K significa quantidade de categorias dentro de um fator e N significa a quantidade de observações consideradas. As siglas em inglês são comumeiramente utilizadas falar falar da "Soma dos quadrados entre os grupos" (SSB), "Soma dos quadrados dentro dos grupos" (SSW), "Quadrado médio entre grupos" (MSB) e "Quadrado médio dentro dos grupos" (MSW). Repare também que,a este momento, os aspectos são apenas apresentados conceitualmente e não matematicamente. Em outro momento, aspectos da decomposição da variância serão também descritos.


```{r}
apaTables::apa.aov.table(mod_escolaridade)
```


A leitura desse resultado é similar a de um modelo de regressão e a de outros modelos lineares e, em linhas gerais, em relatório ou publicações quase sempre apenas se diz que o modelo foi significativo, indicando as principais estatísticas obtidas da seguinte maneira: F(3,143) = 8.231, p < 0.01, ηp2 = 0.15, 90% CI [.06, .22]. 

No entanto, o que essa constatação está realmente dizendo é que houve uma comparação entre dois modelos, um que usou os resultados da variável "escolaridade" para prever os resultados obtidos pelo TEG (chamado de Modelo aumentado) e outro que usou apenas a média que o TEG (chamado de modelo compacto ou nulo neste caso). O resultado significativo indica que a inclusão da "escolaridade" no  modelo testado foi significativamente capaz de reduzir o erro de previsão que o modelo nulo obteve (em ingles Proportional Reduction in Error ou PRE). Ainda nesse caso, o ηp2 (eta parcial quadrado) indica a proporção da variabilidade dos resultados do TEG que pode ser atribuídos à escolaridade e é uma métrica de tamanho do efeito, cuja interpretação se recomenda da seguinte maneira:

  | ηp2             | Interpretação         
  | :-----          :-----     
  | ηp2 $\geq$ 0.14 | Grande 
  | ηp2 $\geq$ 0.06 | Moderado      
  | ηp2 $\geq$ 0.01 | Pequeno
  | ηp2 < 0.01      | Irrelevante

De fato, quando isso ocorre, a busca por possíveis diferenças entre <u>todas as comparações possíveis</u> costuma ser feita por testes post hocs.

Entretanto, é importante mencionar que que se uma ANOVA é significativa, isso não significa necessariamente que haverá alguma diferença <u>entre as médias dos grupos</u>. Tecnicamente, a diferença pode ocorrer em qualquer comparação possível, como grupo 1 contra grupos 2 + grupo 3 ou grupo 2 contra grupo 1+3. Dessa forma, o resultado geral da ANOVA e testes post hoc respondem questões diferentes e é possível realizar qualquer comparação múltipla sem sequer realizar a ANOVA, desde que os resultados sejam devidamente corrigidos caso se assuma alguns pressupostos sobre os constrastes.


Uma vez que realizar uma ANOVA não é tecnicamente necessário para realização de comparações pareadas, é possível que alguém se pergunte qual é, então, a necessidade da realização deste primeiro teste. De fato, hoje em dia, a realização da ANOVA ocorre mais para que o pesquisador (i) consiga realizar computacionalmente todas as comparações pareadas entre as categorias da variável e, em seguida, (ii) corrigir adequadamente o valor de P obtido em cada computação.

Isso dito, uma vez que a <u>escolaridade</u> foi significativa, as principais comparações serão testadas dois a dois.Sempre que múltiplas que comparações são realizadas, é esperado que haja uma inflação do erro do tipo 1 e, por isso, é necessário ajustar o valor de P. Repare que a quantidade de comparações pode ser calculada da seguinte forma:

 \[ J*(\frac{J-1}2) \] , onde
$J$ é a quantidade de níveis da variável

Nesse caso:  

\[ 4*(\frac{3}2) = 6 \]. 

Para a comparação pareada, o pacote `emmeans` será utilizado.

### Post hoc

A mecanica do por detrás do post hoc é a comparação pareada de todos os níveis presentes no fator, seguido pelo ajuste do valor de P. Existem muitas técnicas para tal ajuste e elas costumam ser agrupadas em função da sua robustez à violação da homocedasticidade. Para fins práticos, vamos utilizar uma técnica considerada bastante conservadora, chamada de Bonferroni, que multiplica o valor bruto encontrado pela quantidade de comparações.

O resultado das comparações dois a dois será armazenado em um objeto específico, nomeado como `post_hoc_escolaridade`. Isso será útil para apresentar sumários e gráficos.

```{r, message=FALSE}
library(emmeans)
```


```{r}
post_hoc_escolaridade <- emmeans(mod_escolaridade, "escolaridade") %>% pairs(., reverse = TRUE, adjust = "bonferroni")
```

Tal como feito até agora, o gráfico inicial das comparações será realizado. A adição das barras de erro gera interpretação mais rápida e simples para todas as comparações.

```{r}
CI <- confint(post_hoc_escolaridade)
ggplot(mapping = aes(contrast, estimate)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), data = CI) +
  geom_point(data = summary(post_hoc_escolaridade)) +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  scale_size(trans = "reverse") + 
  coord_flip()

```


A apresentação tabular é fundamental e apresenta as estatísticas inferenciais de interesse:

```{r}
post_hoc_escolaridade %>% 
  kable(digits = 2) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  
```

Os resultados são significativos na comparação `Superior - Primário`, `Superior - Ginásio` e `Superior - Colegial`. Em todos, os resultados do TEG foi mais elevado naqueles participantes que haviam concluído o ensino superior.  

A esse momento, a escrita é fundamental:

```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados a partir de uma ANOVA de uma via investigando o efeito da escolaridade no empreendedorismo, medido por um escala específica. Foi possível concluir que a escolaridade é significativa (F(3, 143) = 8.23, p < 0.01, ηp2 = 0.15, 90% CI [.06, .22]) e as comparações pareadas, ajustadas pela técnica de Bonferroni, mostraram que os participantes com ensino superior apresentam pontuação mais alta do que àqueles com o primário (Δ = 7.16, p < 0.01), ginásio (Δ = 5.07, p < 0.01) e colegial (Δ = 2.96, p < 0.05).  
```


## ANOVA de 2 vias

Frequentemente, o interesse do pesquisador está em investigar como múltiplos fatores afetam a variável de interesse. Ao aumentar o número de variáveis independentes no modelo, se aumenta a quantidade de vias que a ANOVA possui. Se, por exemplo, a investigação visasse testar o efeito da <u>escolaridade</u> e do <u>sexo</u> no <u>empreendedorismo</u>, teríamos, por definição, uma ANOVA de duas vias. É fundamental atentar que essa modelage inicialmente considera apenas os efeitos principais dos fatores e não assume ou modela uma possível interação entre os preditores.

### Execução no R

Após a escrita adequada da hipótese, a modelagem segue o mesmo padrão da feita anteriormente, iniciando pela definição correta do tipo de variável em relação à sua escala de medida.

```{r, eval=FALSE}
dados_teg <- dados_teg %>% 
  mutate_at(vars(sexo), funs(
    factor(case_when(
      . == 1 ~ "Masculino",
      . == 2 ~ "Feminino"), levels=c("Masculino","Feminino"))))
```


Tabelas e gráficos também devem ser apresentadas.

```{r}
dados_teg %>% 
  group_by(escolaridade, sexo) %>% 
  mutate(rn = row_number()) %>% 
  summarise_at(vars(teg), lst(n=~n(), mean, sd)) %>% 
  pivot_wider(names_from = sexo, #indexador unico
              names_sep = "_",  #pode ser removido
              values_from = c(n:sd)) %>%  #organizar valores
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Repare que não há desvio-padrão para mulheres com o ensino superior. Isso ocorre pela quantidade de participantes que satisfazem essas condições. Tecnicamente, isso ou impossibilitaria essa análise ou tornaria a interpretação altamente viesada. No entanto, por condição pedagógica, vamos seguir com o procedimento.

Como o objetivo é verificar duas variáveis isoladamente, os gráficos também podem ser isolados. 

```{r, message=FALSE}
gridExtra::grid.arrange(
  ggplot(dados_teg, aes(x=escolaridade, y = teg, fill = escolaridade)) +
  geom_bar(stat = "summary") +
  stat_summary(fun.data = mean_se, geom = "errorbar"),
  
  ggplot(dados_teg, aes(x = sexo, y = teg, fill = sexo)) +
  geom_bar(stat = "summary") +
  stat_summary(fun.data = mean_se, geom = "errorbar"))

```

Agora, formalmente a modelagem será feita. Os passos devem ser exatamente os mesmos, incluindo a verificação de pressupostos e interpretação dos resultados. A esse momento, a tabela padronizada da ANOVA é a seguinte:


  | Preditor      | Soma dos Quadrados| Graus de liberdade |  Quadrado médio             | Estat. F       | 
  | :-----------  | :-----------      | :-----------       |  :-----------               | :-----------   |  
  | Fator (A)     | Entre (SS(A))     | K(A)-1             |  MS(A) = SS(A)/k-1          | F = MS(A)/MSW  | 
  | Fator (B)     | Entre (SS(B))     | K(B)-1             |  MS(B) = SS(B)/k-1          | F = MS(B)/MSW  | 
  | Resíduo       | Dentro (SSW)      | N-1-(df(A)+df(B))  |  MSW = SSW/N-1-(df(A)+df(B))|                |



Posto isso, os resultados obtidos são:

```{r}
mod_escolaridade_sexo <- lm(teg ~ escolaridade + sexo, dados_teg)
apaTables::apa.aov.table(mod_escolaridade_sexo)
```


Os resultados continuam constantando o efeito da escolaridade (F(3, 142) = 8.24, p < 0.01, ηp2 = 0.15, 90% CI [.06, .22]) no empreendedorismo, mas também concluiu que o efeito do sexo não é significativo (F(1, 142) = 0.816, p = 0.36, ηp2 = 0.01, 90% CI [.00, .04]). É importante ter atenção à forma de reportar os resultados, uma vez que delineamentos de dois fatores quase sempre produz coeficientes são diferentes do delineamento anterior. A análise post hoc que seria feita agora seria a mesma feita anteriormente e, em função disso, será suprimida.


Uma sugestão de escrita desses resultados é a seguinte:



```{r, eval = FALSE, include=FALSE  }
#Apesar de não ter uma interpretação direta, o valor apresentado ao intercepto é o valor médio dos homens com escolaridade primária. Isso ocorre pois como há duas variáveis categóricas sendo analisadas, o valor utilizado para referência (ou seja, 0) do sexo foi para homens e este valor para escolaridade foi para aqueles com ensino primário.

dados_teg %>% filter(sexo == "Masculino" & escolaridade == "Primário") %>% summarise(mean(teg))
summary(lm(teg ~ escolaridade + sexo, dados_teg))$coefficients[1,1] %>% round(.,1)

```


```{block, type="writing"}
**Como escrever os resultados**  

Os dados foram analisados a partir de uma ANOVA de duas vias investigando o efeito da escolaridade e do sexo no empreendedorismo. Foi possível concluir que a escolaridade é um fator significativo aos resultados (F(3, 142) = 8.24, p < 0.01, ηp2 = 0.15, 90% CI [.06, .22]), mas que o sexo não é significativo nessa relação (F(1, 142) = 0.81, p = 0.36, ηp2 = 0.01, 90% CI [.00, .04]).   
```

## ANOVA Fatorial

A ideia da ANOVA fatorial é provavelmente uma das mais frequentes em perguntas de pesquisas, que consistem em tentar saber se os fatores tem alguma interação entre si. Nesse sentido, a modelagem envolve o cálculo de um terceiro parâmetro para investigar essa relação. Dessa maneira:


\[y_i = b_0 + b_1X{_1}_i + b_2X{_2}_i + b_3(X{_1}_i * X{_2}_i) + \epsilon_{i}\]

Os coeficientes $b_1$ e $b_2$ estimam os efeitos principais, enquanto o $b_3$ estima o efeito da interação. 

Dessa vez, é importante ressaltar alguns aspectos:  

1. Apesar de efeitos de interação poderem ser exploratórios, a ideia de adicioná-lo é fortemente relacionada à teoria. Ou seja, a modelagem é frequentemente confirmatória;  

2. A análise gráfica que é especialmente útil a todas as análises é ainda mais necessária nessa técnica;    

3. A interpretação dos resultados <u>sempre</u> começa pela interação. Caso ela seja significativa, não se interpreta os efeitos principais.    

Nessa pesquisa, tivemos o interesse em saber se o nível de empreendedorismo varia em função de uma interação entre `sexo` e  `estado civil` (solteiro ou casado) dos participantes.  Ou seja, se o nível de homens e mulheres variava em função deles(as) serem casados(as) ou não. Em áreas comportamentais, a interação entre o efeito estado civil e do sexo em características sociais é bastante estudado.  

### Execução no R

Como mencionado, é fundamental ajustar todas as características da base para que os resultados não sejam distorcidos em função de definições computacionais. Como nessa pesquisa, também permitimos que pessoas divorciadas e viuvas, uma opção para deixar as análises totalmente pareadas com a pergunta da pesquisa é criar uma base contendo apenas solteiros (originalmente codificados com 1) e casados (originalmente codificados como 2).

```{r}
base_interacao <- dados_teg %>% filter(estado_civil == "1" | estado_civil == "2")
base_interacao <- base_interacao %>% 
  mutate_at(vars(estado_civil), 
    ~factor(case_when(
      . == 1 ~ "solteiro",
      . == 2 ~ "casado"), levels=c("solteiro","casado")))
```

Agora o gráfico apresentado deve combinar as duas variáveis independentes, uma no eixo de X e outro no agrupamento. A escolha de como apresentar estas variáveis não deve ser aleatória, mas ser atrelada à forma da pergunta de pesquisa. Se o interesse for responder "Quanto o estado civil depende do sexo para gerar os resultados do TEG" sugere que em X coloque-se a variável "estado civíl" e no agrupamento a variáel "sexo.

```{r, message=FALSE}
ggplot(base_interacao, aes(x = estado_civil, y = teg, group = sexo, col= sexo)) +
  geom_line(stat = "summary", size=1) + 
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.1, size=1)
```


O gráfico indica que existe um efeito de interação, uma vez que as linhas se cruzam. No entanto, o teste formal deve ser feito. Da mesma forma do realizado anteriormente, a modelagem omitirá a verificação dos pressupostos, que foi apresentada em etapa inicial. 

```{r}
mod_int_sexo_civil <- lm(teg ~ sexo * estado_civil, base_interacao)
apaTables::apa.aov.table(mod_int_sexo_civil)
```


A leitura da tabela começa de cima para baixo, ou seja, pela interação. Neses caso, ela é significativa (F1, 129) = 4.23, p < 0.05, ηp2 = 0.03, 90% CI [.00, .10]). Quando isso acontece, não se deve interpretar os efeitos principais, mesmo que eles sejam significativos. 


### Post hoc


No caso, à pergunta "o sexo tem efeito no empreendedorismo", a resposta adequada seria "depende", uma vez que ele varia em função do estado civil do participante. O post hoc vez será também feito pelo pacote `emmeans`, que já foi carregado anteriormente. Para deixar a rotina clara, vamos armazenar os resultados no objeto `post_hoc_int` e, em seguida, explorar os coeficientes.Repare que dessa vez, os valores de p ajustados ou não são os mesmos, dado que há apenas duas categorias em cada grupo.

```{r}
post_hoc_int <- emmeans(mod_int_sexo_civil, pairwise ~ sexo * estado_civil, adjust = "bonferroni")
```

O resultado deve ser acessado via contrastes.

```{r}
post_hoc_int$contrasts %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


Repare que as informações repetem aquilo já visualizado no gráfico anterior, mas com as correções, a interpretação torna-se menos visual. Os resultados indicam que as mulheres solteiras têm resultados mais elevados do que os homens casados (Δ = 5.74, p = 0.04) e que existe uma tendência das mulheres solteiras, quando comparadas às mulheres casadas, terem também mais empreendedorismo (Δ = 6.22, p = 0.09). Repare que a diferença visual entre homens e mulheres solteiras não é significativa. Em linhas gerais, parece que o empreendedorismo diminui em pessoas casadas e isso é especialmente válido às mulheres.



## Resumo  

Este capítulo apresentou a ANOVA tanto de uma forma bastante pragmática como de uma maneira mais conceitual e, consequentemente, complexa. De forma pragmática, ao classificar a ANOVA como um super teste T, é possível demonstrar a importância da correção do valor de P após múltiplas comparações. Sem esses ajustes, a chance de cometer falsos positivos aumentaria. Já em outro sentido, ao deixar claro que a ANOVA é um caso particular de modelos de regressão, é possível entender que ela é uma análise complexa e que se ajusta bem à grande parte das perguntas empíricas e teóricas realizadas em Psicologia e outras ciências comportamentais.  


<!--chapter:end:06-anova.Rmd-->

# Regressão linear simples


```{r, include = FALSE }
load(file="C:/Users/luisf/OneDrive/Documentos/anovabr/mqt/bases/Livro - Dados - Eating disorders.RData")
library(tidyverse)
library(knitr) #tables and graphs
library(kableExtra) #tables with different styles
library(olsrr) #regression diagnostics
library(gridExtra) #plot together
library(stargazer) #presenting results
```



Os modelos de regressão modelos estatísticos que relacionam o comportamento de uma variável resposta (Y) como uma função de variáveis condicionantes (X). Em larga escala, eles substituem os outros testes paramétricos vistos até agora. Assim, quase tudo o que foi visto durante os capítulos anteriormente são casos especiais de modelos de regressão. No entanto, é possível estudar tais modelos tanto de uma maneira <u>operacional</u>, com foco totalmente pragmático e aderente às recomendações tradicionais dos livros de estatística, ou de uma forma <u>detalhada</u>, em que ao estudar os modelos de regressão, quase que muitos conceitos da estatística inferencial e estatística matemática são revisitados.

Nesse capítulo, iremos ver ambas as maneiras, mas preservando o foco na capacidade operacional.

Conceitualmente, a regressão linear é apresentada como::

\[y_i = b_0 + b_1X{_1}_i + \epsilon_{i}\]

$y_i$ representa a variável dependente  
$b_0$ é o intercepto (coeficiente linear)   
$b_1$ é a inclinação (coeficiente angular)  
$\epsilon_{i}$ é o erro/resíduo   



## Legenda
 
Diferentes termos são empregados em modelos de regressão A legenda a seguir visa auxiliar no entendimento de cada um deles e aproximar o leitor a conceitos amplos utilizados em modelos lineares:

```{block, type="writing"}
**intercepto** (constante) - $b_0$: Valor previsto de Y quando X = 0  
**Inclinação** (slope) - $b_i \forall i  \neq 0$: A diferença média em unidades da variável dependente prevista em Y quando se altera uma unidade de X.  
**SSR**: Soma dos Quadrados da Regressão  
**SSE**: Soma dos Quadrados dos Erros  
**SST**: Soma dos Quadrados Total  
**Variabilidade total** SST = SSR + SSE  
$R^2$ ou **Coeficiente de Determinação**: A porcentagem de variação da variável dependente (Y) que pode ser atribuída à variabilida da(s) variável (is) independente(s) (X)  
$R^2_{adj}$ ou **Coeficiente de Determinação ajustado**: Pondera a porcentagem de variação da variável dependente (Y) que pode ser atribuída à variabilida da(s) variável (is) independente(s) (X) pelo número de variáveis explicativas e pelo número de observações da amostra. É particularmente útil quando deseja-se comparar modelos de regressão múltipla que prevêem a mesma variável dependente, pois penaliza aquele modelo com maior número de variáveis independentes.  
RMSEA ($Res. St. Error$  ou Erro padrão dos resíduos): Desvio padrão dos valores previstos da variável dependente ao redor da linha de regressão estimada  
```

O conhecimento das fórmulas fechadas também auxilia no entendimento da modelagem.

```{block, type="writing"}
Soma dos Quadrados da Regressão: $SSR =  \sum_{i=1}^{n}(\hat{y} - \bar{y})^2$  

Soma dos Quadrados dos Erros: $SSE =  \sum_{i=1}^{n}(y_i - \hat{y})^2$  

Soma dos Quadrados Total: $SST =  \sum_{i=1}^{n}(y_i - \bar{y})^2$  


**Variabilidade total** $SST = SSR + SSE$

$R^2$ ou **Coeficiente de Determinação**:  $ R^2 = \frac{SSR}{SST} = 1- \frac{SSE}{SST}$

Erro quadrático médio (MSE): $SSE =  \sum_{i=1}^{n}(y_i - \hat{y})^2 /N-K$

$R^2_{adj}$ ou **Coeficiente de Determinação ajustado**: $1-\frac{MSE}{MSR}$

$Res. St. Error = \sqrt\frac{SSE}{N-K}$: Erro padrão dos resíduos, se refere ao desvio padrão dos valores previstos da variável dependente ao redor da linha de regressão estimada  
```


É possível citar ao menos três formas de explicar modelos de regressão. Evidentemente, todas são interligadas, mas cada qual apresenta uma ênfase didática diferente. Nesse sentido, a forma mais "conceitual" conta com conjuntos para explicitar o tema, a forma "correlacional" parte de um gráfico de dispersão e a forma "analítica" traz conceitos matemático. A forma correlacional é a mais simples de todas e iniciará o capítulo. A forma correlacional e analítica serão vistas a partir da pesquisa realizada. 

## Explicação conceitual


Inicialmente, é necessário atentar que a `variável dependente (Y)` e a `variável independente (X)` podem ser vistas como conjuntos. No caso:


![](./img/cap_reg_x_y.png)


Repare que ambas as variáveis estão afastadas e não há nenhuma relação entre elas. No entanto, o que frequentemente ocorre é que existe algum grau de relacionamento entre elas, tal como exposto abaixo:

![](./img/cap_reg_x_y2.png)



Nesse caso, vamos assumir que a variável X (independente) é um fator de causalidade à realização da variável dependente (Y). Em outras palavras, uma parte da realização de Y, necessariamente, depende de X. Essa área de interseção é entendida como a parte de Y que pode ser atribuída ou explicada por X. Analiticamente, essa área precisa de algumas transformações algébricas e, em função delas, recebe o nome de `Soma dos Quadrados da Regressão` (SSR, em inglês).


![](./img/cap_reg_x_y_SSR.png)


No entanto, nem toda a variabilidade de Y pode ser atribuída à X. Essa região também sofrerá transformações algébricas e receberá o nome de `Soma dos Quadrados dos Erros` (SSE, em inglês). Essa área representa a variabilidade de Y que não pode ser atribuída/explicada por X. Nesse caso: 

![](./img/cap_reg_x_y_SSE.png)


É também possível verificar que a variável dependente (Y) têm uma variabilidade total, que também pode ser vista como o somatório da área explicada pela regressão (SSR-interseção) com a área não explicada (SSE). Essa região total também passará por transformações algébricas e receberá o nome de `Soma dos Quadrados Total` (SST, em inglês).


![](./img/cap_reg_x_y_SST.png)


Vendo todas as partições de uma única vez, temos o seguinte:


![](./img/cap_reg_x_y_SSR_SSE_SST.png)


Com isso, torna-se claro que a porcentagem de variação da variável dependente (Y) que pode ser atribuída à variabilidade de X é uma razão entre a Soma dos Quadrados da Regressão (SSR) pela Soma dos Quadrados Total (SST). O coeficiente obtido por essa razão recebe o nome de **Coeficiente de Determinação** ou $R^2$.

![](./img/cap_reg_r2.png)



Isso é equivalente a subtração do espaço máximo de variabilidade (100%) pela razão entre a Soma dos Quadrados dos Erros (SSE) pela Soma dos Quadrados Total (SST):


![](./img/cap_reg_r2_1.png)


Evidentemente, modelos em que haja mais de uma variável independente (X) são frequentemente vistos por motivos óbvios. É muito improvável que uma única variável independente consiga explicar a variabilidade de variável dependente. Dessa maneira, é possível considerar Modelos de Regressão múltipla, tal como:

![](./img/cap_reg_multipla_ortogonal.png)

Nesse modelo, há duas variáveis independentes (X1 e X2) e elas não tem nenhuma correlação $\rho_{(X_1,X_2)}=0$

A situação de correlação 0 entre X1 e X2 é muito improvavável. Modelos em que ambas as variáveis apresentam um grau de associação são frequentes:


![](./img/cap_reg_multipla.png)


A área em que existe uma interseção entre X1 e X2 chama-se de colinearidade. Caso haja mais de 2 variáveis também associadas, o nome é multicolinearidade.

![](./img/cap_reg_multipla_colinearidade.png)

Modelos assim serão explicitados em momento posterior.

## Pesquisa  

<div class="alert alert-info" role="alert">
  <strong>Base: </strong> Livro - Dados - Eating disorders
</div>  


Vamos utilizar a pesquisa intitulada "Aspects Related to Body Image and Eating Behaviors in Healthy Brazilian Undergraduate Students", publicada em 2018 no Global Journal of Educational Studies, que sou co-autor.

O objetivo dessa pesquisa foi explorar os fatores envolvidos em transtornos alimentares e aspectos da percepção da imagem corporal, bem como verificar a capacidade que uma medida possuia em predizer os resultados de outra. Esse artigo contou com a utilização de escalas aplicadas em 219 participantes no Brasil. Para acessar aspectos relacionados aos Transtornos alimentares, a escala EAT-26 foi aplicada. Para verificar aspectos da imagem corporal, a escala BSQ-34 foi aplicada.  

Segue abaixo uma tabela inicial com dados descritivos dos resultados.  


```{r}
dados_brasil %>% 
  group_by(sexo) %>% 
  summarise_at(vars(eat_soma, bsq_soma, imc, faz_esporte, familia_esporte), 
               list(~mean(., na.rm = TRUE), ~sd(., na.rm = TRUE))) %>% 
  t() %>%
  kable(., digits = 2,  booktabs = T) %>%
  kable_styling(position = "center", full_width = F, bootstrap_options = "striped")
```


## Regressão linear simples


A Regressão linear é uma técnica estatística utilizada que além de verificar o relacionamento funcional entre duas variáveis, permite criar uma equação que verifique o quanto os valores de uma variável varie em função de outra.

Há, ao menos, duas utilidades diretas em uma pesquisa, que são: 

(i) Predizer os valores da variável dependente (Y) em função dos valores da variável dependente (X);  

(ii) Explicar a variabilidade da variável dependente (Y) em função da variável independente (X). 

Tecnicamente, ambas as utilidades são virtualmente iguais e como a Regressão linear simples pode ser vista a partir de um incremento ou avanço dos modelos de correlação, os aspectos correlacionais devem (e podem) ser inicialmente investigados. 


### Execução no R  

Conforme já exposto, o gráfico de dispersão auxilia na visualização da relação entre as variáveis.A correlação entre ambas as medidas expressa a força e a direção que elas possuem. Enquanto a força é interpretada em `fraca` (0.1), `moderada` (0.3) ou `forte` (0.5), a direção pode ser positiva ou negativa, a depender do sinal. 

```{r}
ggplot(dados_brasil, aes(x = bsq_soma, y = eat_soma)) +
  geom_jitter() +
  labs(x = "Resultados da Escala BSQ-34", y = "Resultados da Escala EAT-26", 
       title = "Correlação entre o BSQ-34 e o EAT-26")
```


Tecnicamente, a correlação (de Pearson) nada mais é do que a padronização da covariância. Dessa forma,

```{r}
(cov(dados_brasil$eat_soma, dados_brasil$bsq_soma))/(sd(dados_brasil$bsq_soma)*sd(dados_brasil$eat_soma))
```

$$r(x,y) = \frac{COV(x,y)}{S(x)*S(y)} = \frac{243.6009}{361.3241} \approx 0.67$$

É necessário testar a hipótese que essa correlação poderia ser 0. A estatística do teste de significância da correlação segue uma distribuição T (n-2) graus de liberdade. Assim:

$$H_{0}: \rho = 0 \\ H_{a}: \rho \neq 0 \\ \alpha = 0.05$$


$$t = \frac{r_{xy}}{\sqrt\frac{1-r^2}{n-2}} = \frac{0.67}{\sqrt\frac{1-0.67^2}{219-2}} = 13.45$$

A comparação do valor calculado com o valor crítico (`r qt(1-(0.05/2), nrow(dados_brasil)-2)`) aponta que a $H_0$ deve ser rejeitada. Assim, conclui-se que a correlação entre os resultados obtidos pelo `BSQ-34` e o `EAT-26` é significativa.


No entanto, é natural que o interesse de pesquisa seja verificar o quanto os resultados do `EAT-26` variam em função do `BSQ-34`, uma vez que alguns achados da literatura comentam que a <u>alterações da alimentação</u> ocorre em função da percepção da <u>imagem corporal</u>. Refraseando um pouco essa pergunta, o interesse agora é prever os valores do `EAT-26` a partir dos valores do `BSQ-34`. Como antes afirmado, esse objetivo é virtualmente identico a calcular o quanto a variabilidade dos resultados do `EAT-26` pode ser explicada pelos resultados do `BSQ-34`. 

Fazer isso pede que se retorne ao gráfico correlacional feito ainda pouco e que tente se ajustar / traçar uma reta que tente tocar na maioria dos pontos. Milhões de retas podem ser traçadas e todas acertarão alguns pontos, mas errarão outros. Por exemplo

```{r}
ggplot(dados_brasil, aes(x = bsq_soma, y = eat_soma)) +
  geom_jitter() +
  labs(x = "Resultados da Escala BSQ-34", y = "Resultados da Escala EAT-26", 
       title = "Correlação entre o BSQ-34 e o EAT-26") +
  geom_abline(slope = c(rnorm(10,0.4,0.5), rnorm(10,0.2,0.2)),color = "red")

```

A necessidade agora é conseguir encontrar uma função que possa gerar uma reta que esteja bem perto dos pontos reais e, consequentemente, minimize os erros. Isso é feito justamente resgatando o conceito de função afim, exposto no ensino médio (e ilustrado ao início do capítulo)


$$\hat{y} = a + bx$$

Repare que agora o valor previsto ($\hat{y}$) depende de duas constantes (`a: intercepto ou coeficiente linear` e `b: inclinação ou coeficiente angular`) e uma variável (x). Apenas por uma questão de simbologia, três alterações são feitas com a equação:    
(i) Os símbolos são alterados. Agora $a = b_0$ e $b = b_1$. A alteração de simbologia não altera em nada os cálculos.  

(ii) Como se sabe que essa reta vai <u>estimar</u> os valores reais $y$, letras minúsculas ou um chapéu sobre as letras será utilizado em vez das letras maiúsculas ou gregas.  

(iii) Para que cada valor estimado seja associado a um participante a letra $i$ será adicionada abaixo do $y$, e do $b_1$.   
Assim, temos que os valores estimados de y, agora $\hat{y}$, são obtidos pelo $b_0$ e $b_1$:

$$\hat{y}_i = b_0 + b_1X{_1}_i$$
No entanto, entre o valor real de y (os pontos que estão no gráfico) e os valores obtidos minha equação, haverá <u>sempre</u> uma certa quantidade de erro de estimativa ($e_i$). Ou seja, os valores estimados de cada participante ($i$) vão ter uma quantidade de erro ($e_i$). Dessa forma, é possível pensar que os valores reais agora possuem uma porção de erro:

$$y_i = a + b_1X{_1}_i+\underbrace{e_i}_\text{aleatório}$$

Do ponto de visto estatístico, é possível traçar milhões de retas, mas para encontrar a reta que minimize os erros, é necessário discriciona-lo.

$$e_i = y_i - \hat{y_i}$$
$$e_i = y_i - (b_0 + b_1X{_1}_i) \\ =  y_i - b_0 - b_1X{_1}_i$$


Quando se minimizar o erro ($\epsilon_{i}$), vai ser possível construir a reta mais próxima a todos os pontos. O método utilizado para isso é o Mínimos Quadrados Ordinários (em inglês, Ordinary Least Squares -- OLS), que visa minimizar a soma do quadrado dos resíduos. Para fazer isso, é necessário derivar os resíduos em relação a $b_0$ e e $b_1$ e igualar a 0:

$$\frac{\partial \epsilon}{\partial \beta_0}  = 0,\\ \frac{\partial \epsilon}{\partial \beta_1} = 0$$

E os resultados permitem concluir que:

$$\begin{aligned}
b_1 &= \frac{\sum_{i = 1}^{n} x_i y_i - \frac{(\sum_{i = 1}^{n} x_i)(\sum_{i = 1}^{n} y_i)}{n}}{\sum_{i = 1}^{n} x_i^2 - \frac{(\sum_{i = 1}^{n} x_i)^2}{n}} = \frac{COV(xy)}{VAR(x)}\\
b_0 &= \bar{y} - b_1 \bar{x}
\end{aligned}$$

Agora torna-se fácil traçar uma linha entre os pontos que minimize os erros. Uma vez que se sabe que:

$$b_1  = \frac{COV(xy)}{VAR(x)}$$
e que:

$$b_0  = \bar{y} - b_1\bar{x}$$


```{r}

b1 <- cov(dados_brasil$bsq_soma, dados_brasil$eat_soma)/var(dados_brasil$bsq_soma)
b0 <- mean(dados_brasil$eat_soma)-(b1*mean(dados_brasil$bsq_soma))

ggplot(dados_brasil, aes(x = bsq_soma, y = eat_soma)) +
  geom_jitter() +
  labs(x = "Resultados da Escala BSQ-34", y = "Resultados da Escala EAT-26", 
       title = "Correlação entre o BSQ-34 e o EAT-26") +
  geom_abline(intercept = b0, slope = b1)
```


É também fácil notar que essa linha passará necessariamente pela média de ambas as variáveis.

```{r}

ggplot(dados_brasil, aes(x = bsq_soma, y = eat_soma)) +
  geom_jitter() +
  labs(x = "Resultados da Escala BSQ-34", y = "Resultados da Escala EAT-26", 
       title = "Correlação entre o BSQ-34 e o EAT-26") +
  geom_abline(intercept = b0, slope = b1) +
  geom_vline(xintercept = mean(dados_brasil$bsq_soma), size=1.5, color = "red", linetype = "dashed") +
  geom_hline(yintercept = mean(dados_brasil$eat_soma), size=1.5, color = "red", linetype = "dashed")


```

Ainda aproveitando o gráfico, agora torna-se mais simples de notar os dados reais, a linha de regressão e as distâncias (resíduos) entre os pontos reais e os previstos. Enquanto o modelo foi preciso em alguns pontos, em outros ele não se saiu assim tão bem. No entanto, como essa reta foi construída pela minimização da soma dos quadrados dos resíduos, isso nos deixa confortável com os resultados.

```{r}
transform(dados_brasil, Fitted = fitted(mod_linear_simples)) %>% 
  ggplot(., aes(y = bsq_soma, x = eat_soma)) +
  geom_point(aes(y = bsq_soma, x = eat_soma, shape = "real"), color="black") + #plot real
  geom_point(aes(y = Fitted, shape =  "previsto"), color="1") + #plot previsto
  geom_smooth(se=FALSE, method = "lm", color = "black") + 
  geom_segment(aes(x = eat_soma, y = bsq_soma, xend = eat_soma, yend = Fitted), color= "red") + #erro ligado
  scale_colour_manual(name = "Legenda",
                      labels = c("Estimados/Previstos", "Reais dos dados"),
                      values = c("green", "black")) +   
  scale_shape_manual(name = "Legenda",
                     labels = c("Estimados/Previstos", "Reais dos dados"),
                     values = c(1, 5)) +
  labs(x = "Escala BSQ-34", y = "Escala EAT-26", title = "Resultados previstos vs. reais")

```


Posto isso, agora vamos, computacionalmente e analiticamente, realizar passo a passo a regressão linear simples. A função `lm` é a nativa para isso. Ela precisa da variável dependente e da variável independente, tal como abaixo.


```{r}
mod_linear_simples <- lm(eat_soma ~ bsq_soma, data = dados_brasil)
```

Existem diferentes maneiras de apresentar o resultado (que já calculamos inicialmente), A função `stargazer`, do pacote com mesmo nome, é uma das mais informativas e práticas. Assim:

```{r, results = "asis"}
stargazer(mod_linear_simples, type = 'latex') 
```


```{block, type="writing"}
**Importante**  

Apesar de todas as informações estarem presentes, os resultados não poderiam ser apresentados pelo `kable()` de maneira adequada. Assim, além do `stargazer`, como feito aqui, é possível contar com a função `summ` do pacote `jtools`, ou com a função `tab_model` do `sjPlot` 
```

Os resultados do `intercepto` ($b_0$) e da `inclinação` $b_1$ já foram analisados anteriormente, mas agora há 4 outros resultados que serão descritos. Em **primeiro momento**, é necessário verificar o ajuste do modelo e isso é feito pela linha `F-statistic`. Esse resultado pode ser obtido (I) comparando os resultados do modelo em questão com um modelo em que apenas o intercepto é utilizado para prever todos os valores ou (ii) verificando o quanto o modelo em questão consegue explicar da variabilidade dos dados. As duas formas serão vistas, a começar pela primeira.

Em termos técnicos, chama-se o modelo em questão de modelo **irrestrito** (ou **Aumentado**), uma vez que ele possui pelo menos um preditor além do intercepto. Por contraste, chama-se o modelo que tem apenas a média de **intercepto-apenas** (ou **Compacto**, ou **restrito** ou **nulo**). Algebricamente, temos o seguinte:

Modelo Compacto: $y_i = b_0 + e_i$  
Modelo Aumentado: $y_i = b_0 + b_1X_{1i} + e_i$

Tanto o modelo compacto quanto o modelo aumentado geram uma quantidade de erro. A Soma dos Quadrados dos Erros (SSE) de ambos os modelos é a métrica utilizada para esse indicador. No R, é chamado de por Residual Sums-of-Squares (RSS).

Algebricamente, temos:

$$SSE =  \sum_{i=1}^{n}(y_i - \hat{y_i})^2$$

One:
$y_i$ = Valor real obtido  
$\hat{y_i}$ = Valor previsto pelo modelo

Repare que a SSE é o denominador da variância. Quão maior o valor da SSE, pior é o modelo. No Modelo Compacto (intercepto-apenas), esse valor é de `r sum(residuals(mod_intercepto_apenas)^2)`. A conta é relativamente simples, tal como ilustrado abaixo.


```{r}
mod_intercepto_apenas <- lm(eat_soma ~ 1, data = dados_brasil)
#SSE - Soma dos quadrados dos erros -- intercept-only
dados_brasil <- dados_brasil %>% #pegar a base
  mutate(erros_intercepto_apenas = residuals(mod_intercepto_apenas)^2) #criar o somatório dos resíduos

dados_brasil %>% 
  summarise(sum(erros_intercepto_apenas)) %>% deframe() -> sse_intercepto_apenas
```


No Modelo Aumentado, o SSE é de 11297.74. Vale lembrar que a previsão dos valores de $\hat{y_i}$ desse modelo conta com os resultados da variável `bsq_soma` 

```{r}
#SSE - Soma dos quadrados dos residuos -- modelo irrestrito
dados_brasil <- dados_brasil %>% 
  mutate(erros_linear_simples = residuals(mod_linear_simples)^2)

dados_brasil %>% 
  summarise(sum(erros_linear_simples)) %>% deframe() -> sse_linear_simples
```

A comparação entre os modelos é feita pela capacidade de redução proporcional do erro (em ingles, Proportional Reduction in Erro ou PRE) que ocorre ao inserir o preditor. Formalmente, estamos diante de um teste de hipóteses que assume, inicialmente, que o valor de $b_1$ poderia ser simplesmente 0. Ou seja:

$$H_0: b_1 = 0 \\  H_a: b_1 \neq 0 \\ \alpha = 0.05$$


Caso o preditor inserido seja "útil" ao modelo, os valores previstos ($\hat{y}$) serão mais próximos aos valores reais e, consequentemente, os erros serão menores. Assim, a razão abaixo apresenta o quanto o Modelo A diminui no erro da estimativa.

$PRE = \frac{SSE(C)-SSE(A)}{SSR(C)}$

Ou

$PRE = 1-\frac{11297.74}{20712}  = 0.4545318$


Pela conta, O Modelo Aumentado possui cerca de 45% menos erro do que o Modelo Compacto. No entanto, não dá para assumir a priori se esse valor é significativo ou não, uma vez que o Modelo Aumentado tem também mais preditores/parâmetros do que o Modelo Compacto. Dessa maneira, é necessário verificar estatísticamente se a adição feita pelo Modelo Aumentado é significativa. Isso é feito a partir de uma Distribuição F e é realizado da seguinte maneira:

$F = \frac{PRE/(PA − PC)}{(1−PRE)/(n−PA)}$

onde:
PRE = Proportional reduction in error  
PA = Quantidade de parâmetros no Modelo A (no caso, 2: $b_0$ e $b_1{eatsoma}$)  
PC = Quantidade de parâmetros no Modelo C (No caso, apenas 1: $b_0$)  
n = Quantidade de participantes (no caso, `r nrow(dados_brasil)`)  

$F = \frac{0.45/(2 − 1)}{(1−0.45)/(219−2)}$

O valor encontrado (180.82) deve ser comparado com o valor crítico associado a um nível de significância específico, que possui distribuição F com PA − PC graus de liberdade no numerador e n−PA no denominador. Nesse caso, considerando 0.05 de significância, o valor crítico é `r qf(1-0.05, 1, 217)`, ou:

$X \sim F_{0.05}(PA − PC,n−PA) \\X \sim F_{0.05}(df = 1, df = 217)$


Como temos visto no decorrer dos capítulos, quão maior a estatística de teste, menor o valor de P. Nesse caso, como o valor calculado é maior do que o valor crítico, o valor de p é menor do que o nível de significância eleito (p =`r pf(q=180.82, df1=1, df2=217, lower.tail=FALSE)`). Isso indica que o Modelo Aumentado significativamente reduz os erros quando comparado ao Modelo Compacto. 


Graficamente, temos a seguinte situação:

```{r}
grid.arrange(
  ggplot(data.frame(x=c(0,5)), aes(x=x)) +
     stat_function(fun=df, args=list(df1=1, df2=217), colour="blue", size=0.5) +
     geom_vline(xintercept = qf(1-0.05, 1, 217)) +
      annotate("text", x=4, y=1.4, label = "Valor crítico") +
     ggtitle("F Distribution"),
  
  ggplot(data.frame(x=c(0,5)), aes(x=x)) +
     stat_function(fun=df, args=list(df1=1, df2=217), colour="blue", size=0.5) +
     geom_vline(xintercept = qf(1-0.05, 1, 217)) +
     geom_vline(xintercept = 180) +
     annotate("text", x=170, y=1.4, label = "Valor calculado") +
     ggtitle("F Distribution"))
```


Agora, após esses cálculos, é possível concluir que a adição de um novo preditor no modelo reduz significativamente o erro presente em um modelo que conte apenas com a média (F(1, 217) = 180.8, p < 0.01). Posto isso, também é possível apresentar a função nativa `anova` que o R executa ao realizarmos a regressão. Repare que os valores encontrados são exatamente os mesmos (20712 para o SSE do Modelo Compacto e 11298 para o SSE do Modelo Aumentado). O valor de F também e p também são os mesmos (180.82 e p < 0,01).

```{r}
anova(mod_intercepto_apenas,mod_linear_simples)
```


No entanto, logo ao início comentamos que o `F-test` aponta para quanto o modelo em questão consegue explicar da variabilidade dos dados. Isso é feito pela razão entre a Regressão Quadrática Média (MSR) do Modelo Aumentado com o Erro Quadrático Médio (MSE) desse mesmo modelo. 

$$ F = \frac{MSR}{MSE}$$


Da mesma maneira que foi explicado durante a ANOVA, o MSE é fruto da razão entre o SSR pelos graus de liberdade (K-1, considerando aqui o intercepto) e o MSR é fruto da razão entre o SSR pelos graus de liberdade (N-K, considerando também o intercepto). Nesse caso, o df do Modelo Aumentado é igual a 2 ($b_0$ e $b_1$) e o df do resíduo é igual a 217 (219-2).

Abaixo a prova matemática:

```{r}
dados_brasil %>% 
  mutate(SSR_modelo_aumentado = (predict(mod_linear_simples)-mean(bsq_soma))^2) %>% 
  mutate(SSR_modelo_residuos = (predict(mod_linear_simples)-bsq_soma)^2) %>% 
  summarise(F_statistic = (sum(SSR_modelo_aumentado)/(2-1))/(sum(SSR_modelo_residuos)/(nrow(dados_brasil)-2)))
```

Com isso posto, agora é possível montar a tabela inicial da regressão, que é exatamente igual ao que foi exposta no capítulo sobre a ANOVA (de uma via):

  | Source    | SS         | df  | MS        | F-Value        | P-Value  | 
  | :-----    | :-----     | :-- | :-----    | :-----         | :-----   |  --
  | Explicada | SSR (Regressão) | K-1 | MSR       | SSR/K-1        | MSR/MSE  |  -- 
  | Erro   | SSE (Erro)      | N-K | MSE       | SSE/N-K        | --       |  -- 
  | Total     | SST (Total)     | N-1 | var(y)    |  --            | --       |  -- 
  

Com os valores reais, essa tabela fica:

  | Source | SS     | df  | MSE    | F-Value | P-Value 
  | :----- | :----- | :-- | :----- | :-----  | :-----   
  | Explicada | `r round(SSR_modelo_aumentado,1)` | 2-1 | `r  round(SSR_modelo_aumentado/1,1)` | `r (SSR_modelo_aumentado/1)/(SSE_modelo_aumentado/217)`  |  -- 
  | Resíduo   | `r  round(SSE_modelo_aumentado,1)` | 219-2 | `r SSE_modelo_aumentado/217` | --       |  -- 
  | Total     | `r  round(sst_modelo_aumentado,1)` | 219-1 | --      | --       |  -- 
  
  
  
Dito isso, o **segundo momento** é ainda calcado na análise dos resíduos. No caso, a raiz quadrada do erro quadratico médio indica o desvio padrão dos valores previstos da variável dependente ao redor da linha de regressão estimada. Algebricamente:

$$RMSE = \sqrt\frac{SSE}{N-K} = \sqrt{MSE}$$

No caso específico:

$$RMSE = \sqrt\frac{163401}{219-2} = 27.44$$

O **terceiro momento** se relaciona à interpretação do $R^2$. Também chamado de **Coeficiente de Determinação**, ele mensura o quanto a variação total da variável dependente pode ser atribuída às variáveis independentes do modelo. Matematicamente, ele é equivalente ao PRE entre o Modelo Compacto e o Modelo Aumentado que, por sua vez, é equivalente à razão entre o SSR e a SST do Modelo Aumentado ou 1 - (SSE/SST)

Assim, o PRE era:

$PRE = \frac{SSE(C)-SSE(A)}{SSR(C)}=\frac{299560.7-163401}{299560.7}  = 0.4545318$

Enquanto O R2 tem o mesmo valor:
$R^2 = \frac{SSR}{SST} = \frac{136159.8}{299560.7} = 0.454$   
$R^2 = 1-\frac{SSE}{SST} = 1- \frac{163401}{299560.7} = 0.454$  


Nesse caso, cerca de 45% da variabilidade dos resultados da Escala EAT-26 podem ser atribuídos à variabilidade da Escala BSQ-34.

```{r, eval=FALSE}
#Soma dos Quadrados Explicados - SSR
SSR_modelo_aumentado <- dados_brasil %>% 
  mutate(SSR_modelo_aumentado = (predict(mod_linear_simples)-mean(eat_soma))^2) %>%
  summarise(SSR_modelo_aumentado = (sum(SSR_modelo_aumentado))) %>% 
  as.numeric() #9414.255

#Soma dos Quadrados dos erros - SSE
SSE_modelo_aumentado <- dados_brasil %>% 
  mutate(SSE_modelo_aumentado = (predict(mod_linear_simples)-eat_soma)^2) %>%
  summarise(SSE_modelo_aumentado = (sum(SSE_modelo_aumentado))) %>% 
  as.numeric() #11297.74

#Soma dos quadrados total - SST
sst_modelo_aumentado <- dados_brasil %>% 
  mutate(sst_modelo_aumentado = (eat_soma-mean(eat_soma))^2) %>%
  summarise(sst_modelo_aumentado = (sum(sst_modelo_aumentado))) %>% 
  as.numeric() #20712
```


Finalmente, o **quarto momento** é entender o $R^2 ajustado$. Uma vez que modelos com mais parâmetros/preditores, independente da relevância deles, vão sempre ter $R^2$ maior do que modelos mais compactos e, portanto, mais parcimoniosos, é necessário introduz uma punição ancorada na quantidade de preditores inseridos. Essa punição é realizada pelo $R^2 ajustado$, que irá considerar a complexidade do modelo. Algebricamente é a mesma coisa que $1-\frac{MSE}{MST} = 1-\frac{MSE}{VAR(Y)}$, como pode ser visto abaixo:

$$Adjusted R^2 = 1 - \frac{SSE/(N-K)}{SST/(N-1)} = 1-\frac{11297/217}{20712/218} = 1-\frac{52}{95} = 1 - 0.547 = 0.452$$
```{r, eval=FALSE}

#variance 
sum((mean(dados_brasil$eat_soma)- dados_brasil$eat_soma)^2)/218
var(dados_brasil$eat_soma)
```


Com tais resultados descritos, agora é possível retornar aos coeficientes obtidos na regressão, que estão novamente listados abaixo.

```{r}
stargazer(mod_linear_simples, type = "text")
```

O `intercepto` é chamado de `constante` na maior parte dos programas e isso não é diferente no `stargazer`. No caso, ele se refere ao valor médio/esperado de Y quando X=0. Ou seja, se alguém tiveSSR tirado o valor 0 na escala BSQ-34, o valor previsto para os resultados da Escala EAT-26 seria de 1.55, tal como provado abaixo:

```{r}
predict(mod_linear_simples, data.frame(bsq_soma=c(0)))
```

É importante notar que frequentemente o intercepto não tem interpretação lógica e, por isso, costuma ser desconsiderado. No entanto, é possível centralizar os valores do preditor $(x_i-\bar{x})$ para que o intercepto se torne o valor médio da variável dependente.

É também importante atentar que o valor do intercepto não é significativo, indicando que ele não é significativamente diferente de 0.

Já o coeficiente do `bsq_soma`, que se refere os resultados obtidos a partir da Escala BSQ-34 é 0.177 e significativo. Isso significa que 1 unidade de mudança nos resultados da BSQ-34 geram 0.177 unidade de mudança, em média, nos resultados da Escala BSQ-34. 

É importante atentar que o Erro Padrão (Std. Error) é justamente o que permite verificar a significância do resultado e segue uma T com n-2 graus de liberdade. Nesse caso, para o Intervalo de Confiança de `b1` é: 

$$CI = b1 \pm t_{\alpha/2},_{n-2}*SE(b_1))
\\ b1 - SE(b_1) ≤ b1 ≤ b1 + SE(b_1)$$

$$CI = b1 \pm t_{\alpha/2},_{n-2}\sqrt{\dfrac{SSE/(N-k)}{\sum_{i=1}^{n}(x_i - \bar{x})^2}}$$

```{r, eval=FALSE, include=FALSE}
sqrt(SSE_modelo_aumentado/217/sum((dados_brasil$bsq_soma-mean(dados_brasil$bsq_soma))^2))

#Erro padrao do b1
sqrt(SSE_modelo_aumentado/217)/sqrt(var(dados_brasil$bsq_soma)*218)

sqrt(SSE_modelo_aumentado/217)/(sqrt(218)*sd(dados_brasil$bsq_soma))

#Erro padrao do b1
sqrt(SSE_modelo_aumentado/217)*(1/sqrt(var(dados_brasil$bsq_soma)*218))

#http://users.stat.ufl.edu/~winner/qmb3250/notespart2.pdf

```

Torna-se claro, dessa forma, que a estatística T encontrada nada mais é do que:

$$T = \frac{b_1}{SE(b_1)} \\ T = \frac{2.5640}{0.1907} = 13.44$$

É importante atentar que na regressão linear simples, o intervalo de confiança de $b_1$ é análogo à razão entre o RMSE por toda variação ao entorno de X

$$CI(b1)=\frac{RMSE}{\sqrt{n-1*S^2X}}$$

```{r, eval= FALSE}
sqrt(SSE_modelo_aumentado/217)

(SSE_modelo_aumentado/217)*(1/219)+(mean(dados_brasil$bsq_soma)^2)/(sum((mean(dados_brasil$bsq_soma)- dados_brasil$bsq_soma)^2))

#Erro padrão do b0
sqrt((SSE_modelo_aumentado/217))*sqrt(((1/219)+(mean(dados_brasil$bsq_soma)^2)/(sum((mean(dados_brasil$bsq_soma)- dados_brasil$bsq_soma)^2))))


(SSE_modelo_aumentado/217)/sqrt(((1/219)+(mean(dados_brasil$bsq_soma)^2)/(sum((mean(dados_brasil$bsq_soma)- dados_brasil$bsq_soma)^2))))

#https://www.ics.uci.edu/~sternh/courses/210/slides2new.pdf

```

Em relação ao `intercepto`, o intervalo de confiança também é baseado no erro padrão, tal como descrito abaixo:

$$CI = b0 \pm t_{\alpha/2},_{n-2}*SE(b_0))
\\ b0 - SE(b_0) ≤ b0 ≤ b0 + SE(b_0)$$

$$SS_{b0} = \sqrt{SSE/(N-K)(\frac{1}{n}+\frac{\bar{x}^2}{\sum_{i=1}^{n}(x_i - \bar{x})^2}})$$


A estatística de teste é dada pela razão entre a estimativa e o erro padrão.

$$ T = \frac{b0}{SE(b1)} \\ = \frac{0.177}{0.013} \\ \approx 13.4  $$

```{r}

```


## Pressupostos 

```{r}
ggplot(dados_brasil, aes(x = bsq_media, y  = bsq_soma)) +
  geom_line()
```


```{r}
cov(dados_brasil$eat_soma,dados_brasil$bsq_soma)/var(dados_brasil$eat_soma)
mean(dados_brasil$bsq_soma)-cov(dados_brasil$eat_soma,dados_brasil$bsq_soma)/var(dados_brasil$eat_soma)*mean(dados_brasil$eat_soma)
```

Para utilizar os resultados, alguns pressupostos precisam ser atendidos. Tanto gráficos como testes formais podem ser utilizados para isso.

O primeiro é a linearidade.

```{r}
ggplot(dados_brasil, aes(x = eat_soma, y = bsq_soma)) +
  geom_jitter() +
  geom_smooth(method = "lm")
```


Em seguida, a independência dos resíduos, que pode ser calculada pela Variance inflation factors (VIF). Caso o valor do VIF supere 4, há sinal de multicolinearidade.

$VIF = \frac{1}{1 - {R}^{2}_{k}} = \frac{1}{Tolerance}$

```{r}
library(olsrr)
#ols_vif_tol(mod_linear_simples)
```

Os erros devem ser normalmentre distribuídos. Isso pode ser feito por um Q-Q plot. É indicado que não haja diferença entre a linha azul e a vermelha. Evidentemente, com dados empíricos (reais) isso é muito difícil.

```{r}
ols_plot_resid_qq(mod_linear_simples)
```


É também possível checar por um histograma, em que as barras devem ter similaridade à linha que apresenta a distribuição normal.

```{r}
ols_plot_resid_hist(mod_linear_simples)

```

Os testes formaiss são o Shapiro-wilk, Kolgomorov-Smirnov, Cramer-von Mises e Anderson Darling. Em todos, a hipótese nula é de que os resíduos são normalmente distribuídos. Em função da modelagem matemática de cada um deSSRs testes, é esperado que eles tenham uma baixa performance em amostras menores que 30 e que os resultados entre eles sejam distintos quando a amostra é superior a 30, mas inferior a 200. A literatura tem mostrado que o Shapiro-Wilk é o teste com maior poder para detectar desvios da normalidade 

```{r}
ols_test_normality(mod_linear_simples)
```

De forma similar ao observado nos gráficos, os resultados majoritariamente apontam para normalidade dos resíduos.


As variâncias devem ser iguais (homocedasticidade). Iso pode ser visto em um gráfico de dispersão em que x é o valor previsto (fitted values) e y é o valor dos resíduos (residual). Traçar uma linha no centro de y facilita a visualização. O ideal é que padrões não sejam encontrados.

```{r}
include_graphics("img/cap_reg_homocedasticidade.png")
```


```{r}
ols_plot_resid_fit(mod_linear_simples)
```

É possível visualizar que eSSR pressuposto é violado.

Exstem diferentes testes formais, como o Bartlett e o Breusch-Pagan. Os resultados costumam convergir e, em função da praticidade computacional, optaremos pelo teste de Breusch-Pagan. Nesseteste, os resultados tem distribuição qui-quadrado e a hipótese nula assume homocedasticidade. Portanto, a estatística de teste deveria ser insignificante para que a homocedasticidade pudeSSR ser aceita.


```{r}
ols_test_breusch_pagan(mod_linear_simples)
```


## A interpretação

Posto isso, 

<!--chapter:end:08-regressao_linear_simples.Rmd-->

